# Диаграммы архитектуры Serena

## 1. Общая архитектура Serena

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLAUDE CODE                             │
│                      (AI Assistant)                             │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     │ MCP Protocol
                     │
┌────────────────────▼────────────────────────────────────────────┐
│                     SERENA MCP SERVER                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   SerenaAgent                            │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐        │  │
│  │  │  Project   │  │   Tool     │  │   Memory   │        │  │
│  │  │  Manager   │  │  Registry  │  │  Manager   │        │  │
│  │  └────────────┘  └────────────┘  └────────────┘        │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
    ┌────▼────┐           ┌─────▼──────┐
    │ Project │           │  Language  │
    │ Config  │           │  Servers   │
    │(.serena)│           │   (LSP)    │
    └─────────┘           └────────────┘
         │
         ├─ project.yml
         ├─ memories/
         └─ cache/
```

## 2. Структура файловой системы проекта

```
Корень репозитория (D:\1C-Enterprise_Framework\)
│
├── .serena/                              ← ГЛАВНАЯ КОНФИГУРАЦИЯ
│   │
│   ├── project.yml                       ← Настройки проекта
│   │   ├─ language: python
│   │   ├─ ignored_paths: []
│   │   ├─ read_only: false
│   │   └─ project_name: "..."
│   │
│   ├── memories/                         ← СИСТЕМА ПАМЯТИ
│   │   ├── project_overview.md          ← Общий обзор
│   │   ├── active_project_context.md    ← Текущий контекст
│   │   ├── 1c_code_conventions.md       ← Конвенции
│   │   │
│   │   ├── project_251029_*_overview.md ← Обзор подпроекта
│   │   ├── project_251027_*_overview.md
│   │   └── project_250928_*_overview.md
│   │   │
│   │   ├── detailed_analysis_*.md       ← Детальные анализы
│   │   └── serena_*.md                  ← Специфичные для Serena
│   │
│   ├── cache/                            ← КЭШ (автоматически)
│   │   ├── symbols/
│   │   └── indexes/
│   │
│   └── bsl-config.json                   ← Настройки для BSL
│
├── src/
│   └── projects/
│       └── configuration/
│           ├── 251029_GKSTCPLK-1831/     ← "Подпроект" 1
│           │   ├── .serena/              ← Пустая (не используется)
│           │   ├── src/
│           │   └── docs/
│           │
│           ├── 251027_GKSTCPLK-1788/     ← "Подпроект" 2
│           │   └── .serena/              ← Пустая (не используется)
│           │
│           └── 250928_GKSTCPLK-1706/     ← "Подпроект" 3
│               └── .serena/              ← Пустая (не используется)
│
├── docs/                                 ← Документация
├── scripts/                              ← Скрипты
└── serena/                               ← Сам инструмент (submodule)
```

## 3. Процесс онбординга

```
START
  │
  ├─ Claude запускается в проекте
  │
  ▼
┌─────────────────────────────────────┐
│ check_onboarding_performed()        │
│ Проверка: есть ли memories?         │
└────────┬────────────────────────────┘
         │
         ├─ Если memories = []
         │  (Онбординг НЕ выполнен)
         │
         ▼
┌─────────────────────────────────────┐
│ onboarding()                        │
│ Запуск процесса онбординга          │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ ШАГ 1: Изучение структуры           │
│ - list_dir(recursive=true)          │
│ - find_file("README.md")            │
│ - find_file("package.json")         │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ ШАГ 2: Чтение ключевых файлов       │
│ - read_file("README.md")            │
│ - read_file("CLAUDE.md")            │
│ - read_file(".gitignore")           │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ ШАГ 3: Анализ проекта               │
│ - Определение языка                 │
│ - Структура папок                   │
│ - Основные компоненты               │
│ - Build system                      │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ ШАГ 4: Создание памяти              │
│ write_memory(                       │
│   "project_overview",               │
│   content="..."                     │
│ )                                   │
│                                     │
│ write_memory(                       │
│   "suggested_commands",             │
│   content="..."                     │
│ )                                   │
│                                     │
│ write_memory(                       │
│   "task_completion_checklist",      │
│   content="..."                     │
│ )                                   │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ ШАГ 5: Индексация (опционально)     │
│ uv run index-project                │
└────────┬────────────────────────────┘
         │
         ▼
       DONE
    (Онбординг завершен)
```

## 4. Система памяти (Memory System)

```
┌───────────────────────────────────────────────────────────┐
│                     SERENA MEMORY                         │
│                  (.serena/memories/)                      │
└─────────────┬─────────────────────────────────────────────┘
              │
              ├─── TIER 1: Базовая память (после онбординга)
              │    ├─ project_overview.md
              │    ├─ suggested_commands.md
              │    └─ task_completion_checklist.md
              │
              ├─── TIER 2: Конвенции и правила
              │    ├─ 1c_code_conventions.md
              │    ├─ code_style_guide.md
              │    └─ naming_conventions.md
              │
              ├─── TIER 3: Контекст работы
              │    ├─ active_project_context.md
              │    └─ current_task_state.md
              │
              ├─── TIER 4: Обзоры подпроектов
              │    ├─ project_251029_GKSTCPLK-1831_overview.md
              │    ├─ project_251027_GKSTCPLK-1788_overview.md
              │    └─ project_250928_GKSTCPLK-1706_overview.md
              │
              ├─── TIER 5: Детальные анализы
              │    ├─ detailed_analysis_ARM_IntermediateComposite.md
              │    ├─ detailed_analysis_ARM_Registration.md
              │    └─ detailed_analysis_Quality_Control.md
              │
              └─── TIER 6: Специализированная память
                   ├─ serena_auto_project_switching.md
                   ├─ serena_bsl_integration_status.md
                   └─ mcp_integration_guide.md
```

### Использование памяти

```
Claude запрос → "Проанализируй АРМ"
                      ↓
                 list_memories()
                      ↓
         ┌────────────┴────────────┐
         │                         │
    Есть память?              Нет памяти?
         │                         │
         ▼                         ▼
    read_memory(         Провести анализ
    "detailed_analysis_       ↓
     ARM_*")             write_memory(
         │               "detailed_analysis_
         ▼                ARM_*")
    Использовать              ↓
    существующий          Сохранить
    анализ               результат
```

## 5. Работа с "подпроектами"

```
┌──────────────────────────────────────────────────────────────┐
│          ОДИН ГЛАВНЫЙ ПРОЕКТ В SERENA                        │
│       D:\1C-Enterprise_Framework                             │
└────────────────────┬─────────────────────────────────────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
┌─────────┐   ┌─────────┐   ┌─────────┐
│Подпроект│   │Подпроект│   │Подпроект│
│ 251029  │   │ 251027  │   │ 250928  │
└────┬────┘   └────┬────┘   └────┬────┘
     │             │             │
     │  НЕ являются отдельными  │
     │  проектами в Serena!     │
     │                           │
     └───────────┬───────────────┘
                 │
                 ▼
         Управляются через
         СИСТЕМУ ПАМЯТИ:
                 │
     ┌───────────┼───────────┐
     │           │           │
     ▼           ▼           ▼
project_     project_    project_
251029_*     251027_*    250928_*
overview     overview    overview
```

### Переключение между "подпроектами"

```
Пользователь: "Работаем с проектом 251029"
                      ↓
              ┌───────────────┐
              │ Claude Code   │
              └───────┬───────┘
                      │
                      ▼
         ┌────────────────────────┐
         │ write_memory(          │
         │   "active_project_     │
         │    context",           │
         │   "Текущий: 251029"    │
         │ )                      │
         └────────┬───────────────┘
                  │
                  ▼
         ┌────────────────────────┐
         │ read_memory(           │
         │   "project_251029_*_   │
         │    overview"           │
         │ )                      │
         └────────┬───────────────┘
                  │
                  ▼
              Работа в новом
              контексте
```

## 6. Инструменты Serena (Tools)

```
┌──────────────────────────────────────────────────────────────┐
│                    SERENA TOOLS                              │
└────────────┬─────────────────────────────────────────────────┘
             │
             ├─── FILE TOOLS (file_tools.py)
             │    ├─ read_file          - Чтение файла
             │    ├─ list_dir           - Список файлов
             │    ├─ search_for_pattern - Поиск по regex
             │    └─ create_text_file   - Создание файла
             │
             ├─── SYMBOL TOOLS (symbol_tools.py)
             │    ├─ find_symbol              - Поиск символов
             │    ├─ get_symbols_overview     - Обзор символов
             │    ├─ find_referencing_symbols - Поиск ссылок
             │    ├─ replace_symbol_body      - Замена тела символа
             │    ├─ insert_after_symbol      - Вставка после
             │    └─ insert_before_symbol     - Вставка перед
             │
             ├─── MEMORY TOOLS (memory_tools.py)
             │    ├─ write_memory   - Создание воспоминания
             │    ├─ read_memory    - Чтение воспоминания
             │    ├─ list_memories  - Список воспоминаний
             │    └─ delete_memory  - Удаление воспоминания
             │
             ├─── CONFIG TOOLS (config_tools.py)
             │    ├─ activate_project      - Активация проекта
             │    ├─ get_current_config    - Текущая конфигурация
             │    └─ switch_modes          - Переключение режимов
             │
             └─── WORKFLOW TOOLS (workflow_tools.py)
                  ├─ check_onboarding_performed - Проверка онбординга
                  ├─ onboarding                 - Запуск онбординга
                  ├─ think_about_collected_info - Размышление
                  └─ think_about_task_adherence - Проверка выполнения
```

## 7. Language Server Protocol (LSP) интеграция

```
┌──────────────────────────────────────────────────────────────┐
│                    SERENA AGENT                              │
└────────────┬─────────────────────────────────────────────────┘
             │
             ▼
┌──────────────────────────────────────────────────────────────┐
│              SolidLanguageServer                             │
│           (Unified LSP Wrapper)                              │
└────────────┬─────────────────────────────────────────────────┘
             │
     ┌───────┴────────┐
     │                │
     ▼                ▼
┌─────────┐      ┌─────────┐
│Language │      │Language │
│Server 1 │ ...  │Server N │
└────┬────┘      └────┬────┘
     │                │
     ▼                ▼
┌─────────┐      ┌─────────┐
│ Python  │      │   Go    │
│ Pyright │      │  gopls  │
└─────────┘      └─────────┘

Для BSL: Language Server отсутствует
         ↓
    Используются FILE TOOLS
    (без symbol operations)
```

## 8. Contexts и Modes

```
┌──────────────────────────────────────────────────────────────┐
│                      CONTEXTS                                │
│              (Определяют набор инструментов)                 │
└────────────┬─────────────────────────────────────────────────┘
             │
             ├─── desktop-app
             │    └─ Все инструменты + UI интеграция
             │
             ├─── agent
             │    └─ Автономная работа + планирование
             │
             └─── ide-assistant
                  └─ Интеграция с IDE + ограниченные права

┌──────────────────────────────────────────────────────────────┐
│                        MODES                                 │
│               (Определяют режим работы)                      │
└────────────┬─────────────────────────────────────────────────┘
             │
             ├─── interactive
             │    └─ Вопросы пользователю + пошаговая работа
             │
             ├─── editing
             │    └─ Активное редактирование кода
             │
             ├─── planning
             │    └─ Планирование без выполнения
             │
             └─── one-shot
                  └─ Однократная задача без контекста
```

## 9. Жизненный цикл сессии Serena

```
START
  │
  ▼
┌─────────────────────────────────────┐
│ 1. Запуск serena-mcp-server         │
│    cd project/                      │
│    serena-mcp-server                │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 2. Инициализация                    │
│    - Чтение project.yml             │
│    - Загрузка конфигурации          │
│    - Применение contexts/modes      │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 3. Подключение Claude Code          │
│    - MCP handshake                  │
│    - Регистрация инструментов       │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 4. Проверка онбординга              │
│    check_onboarding_performed()     │
│    ├─ Если НЕТ → onboarding()       │
│    └─ Если ДА → list_memories()     │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 5. Рабочий цикл                     │
│    ┌──────────────┐                 │
│    │ Запрос       │                 │
│    │ пользователя │                 │
│    └──────┬───────┘                 │
│           │                         │
│           ▼                         │
│    ┌──────────────┐                 │
│    │ Использование│                 │
│    │ инструментов │                 │
│    └──────┬───────┘                 │
│           │                         │
│           ▼                         │
│    ┌──────────────┐                 │
│    │ Обновление   │                 │
│    │ памяти       │                 │
│    └──────┬───────┘                 │
│           │                         │
│           ▼                         │
│    ┌──────────────┐                 │
│    │ Ответ        │                 │
│    │ пользователю │                 │
│    └──────────────┘                 │
└─────────────────────────────────────┘
         │
         ▼
       END
    (Завершение сессии)
```

## 10. Сравнение: традиционные vs Serena проекты

### Традиционный подход (без Serena)

```
Project A/
├── src/
├── tests/
└── docs/

Project B/
├── src/
├── tests/
└── docs/

Project C/
├── src/
├── tests/
└── docs/

Каждый проект изолирован
Нет общей памяти
Нет контекста между проектами
```

### Подход Serena (наш случай)

```
Main Project (1C-Enterprise_Framework)/
│
├── .serena/                      ← Единая конфигурация
│   ├── project.yml
│   └── memories/                 ← Общая память
│       ├── project_overview.md
│       ├── project_251029_*
│       ├── project_251027_*
│       └── project_250928_*
│
├── src/projects/configuration/
│   ├── 251029_GKSTCPLK-1831/    ← "Подпроект" 1
│   ├── 251027_GKSTCPLK-1788/    ← "Подпроект" 2
│   └── 250928_GKSTCPLK-1706/    ← "Подпроект" 3
│
└── Все "подпроекты" в едином контексте
    Общая память и конвенции
    Переключение через активный контекст
```

---

## Легенда символов

```
│  Вертикальная связь
├  Разветвление
└  Конечный элемент
▼  Направление потока
┌─┐ Прямоугольник (компонент)
→  Стрелка (действие)
```

---

**Дата создания**: 2025-10-29
**Версия**: 1.0
