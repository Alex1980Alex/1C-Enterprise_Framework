// @strict-types

#Область ПрограммныйИнтерфейс

// Результаты нормативной сертификации номенклатуры с показателем усиленного контроля.
// 
// Параметры:
//  ОбъектДокумента Объект документа
//  ТребуетсяУсиленныйКонтрольЛабАнализа Требуется усиленный контроль лаб анализа
//  ДополнительныеПараметры - Неопределено - Дополнительные параметры
// 
// Возвращаемое значение:
//  Массив - Результаты нормативной сертификации номенклатуры с показателем усиленного контроля
Функция РезультатыНормативнойСертификацииНоменклатурыСПоказателемУсиленногоКонтроля(ОбъектДокумента, 
	ТребуетсяУсиленныйКонтрольЛабАнализа, ДополнительныеПараметры = Неопределено) Экспорт
	
	Результат = Новый Массив;
	
	ПараметрыЗапроса = ПолучитьПараметрыЗапросаНормативнойСертификации(ОбъектДокумента, ДополнительныеПараметры);
		
	Если НЕ ЗначениеЗаполнено(ПараметрыЗапроса.Номенклатура) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Контрагент = Неопределено;
	ПараметрыЗапроса.Свойство("Контрагент", Контрагент);
	
	Показатель = Неопределено;
	ПараметрыЗапроса.Свойство("Показатель", Показатель);
	
	ТекущиеЗначениеПоказателя = Неопределено;
	ПараметрыЗапроса.Свойство("ТекущиеЗначениеПоказателя", ТекущиеЗначениеПоказателя);
	
	// Дополнительный параметр для усиленного контроля
	ДокументРегистрации = Неопределено;
	ПараметрыЗапроса.Свойство("ДокументРегистрации", ДокументРегистрации);

	
	УстановитьПривилегированныйРежим(Истина);
	
	// Устанавливаем параметры запроса для получения данных 
	Период = ПараметрыЗапроса.Период;
	ДатаНачала = ?(ЗначениеЗаполнено(Период.ДатаНачала), Период.ДатаНачала, ТекущаяДатаСеанса());
	ДатаОкончания = ?(ЗначениеЗаполнено(Период.ДатаОкончания),
			Период.ДатаОкончания, Константы.гкс_ДатаОкончанияПериодаСертификацииПоУмолчанию.Получить());

	Запрос = Новый Запрос;
	Запрос.Текст = УстановитьТекстЗапросаОбъединенногоПолученияПоказателей();
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ДатаОкончания));
	Запрос.УстановитьПараметр("Номенклатура", ПараметрыЗапроса.Номенклатура);
	Запрос.УстановитьПараметр("ТочкаМаршрута", ПараметрыЗапроса.ТочкаМаршрута);
	Запрос.УстановитьПараметр("ВидПеревозки", ПараметрыЗапроса.ВидПеревозки);
	Запрос.УстановитьПараметр("НазначениеИспользованияКачества", ПараметрыЗапроса.НазначениеИспользованияКачества);
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	// Дополнительный параметр для усиленного контроля
	Запрос.УстановитьПараметр("ДокументРегистрации", ДокументРегистрации);
	Запрос.УстановитьПараметр("УсиленныйКонтроль", ТребуетсяУсиленныйКонтрольЛабАнализа);
	
	Если ЗначениеЗаполнено(Показатель) Тогда
		ТекстУсловияПоказательАнализа = "ПоказательАнализа = &ПоказательАнализа";
		ТекстУсловияПоказательУсиленногоКонтроля = "УсилКонтр.Показатель = &ПоказательАнализа";
		Запрос.УстановитьПараметр("ПоказательАнализа", Показатель);
	Иначе
		ТекстУсловияПоказательАнализа = "ИСТИНА";
		ТекстУсловияПоказательУсиленногоКонтроля = "ИСТИНА";
	КонецЕсли;
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТекстУсловияПоказательАнализа", ТекстУсловияПоказательАнализа);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ТекстУсловияПоказательУсиленногоКонтроля", 
			ТекстУсловияПоказательУсиленногоКонтроля);
	
	ЕстьТекущиеЗначения = ТипЗнч(ТекущиеЗначениеПоказателя) = Тип("Соответствие");
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ЭлементРезультата = СтруктураДанныхПоПоказателю();
		ЗаполнитьЗначенияСвойств(ЭлементРезультата, Выборка);
		
		Если ЕстьТекущиеЗначения Тогда
			ОбработатьТекущиеЗначенияПоказателя(ЭлементРезультата, ТекущиеЗначениеПоказателя, Выборка);
		КонецЕсли;
		
		Результат.Добавить(ЭлементРезультата);
		
	КонецЦикла;
	
	Возврат Результат;
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Получить структуру нормативной сертификации номенклатуры.
// 
// Возвращаемое значение:
//  Структура - Получить структуру нормативной сертификации номенклатуры:
// * Номенклатура - 
// * Характеристика - 
// * Показатель -
// * ЕдиницаИзмерения -
// * МинимальноеЗначение - 
// * МаксимальноеЗначение -
// * Базис -
// * ПериодС -
// * ПериодПо -
// * ГОСТ -
// * ОтклонениеОтБазиса -
// * СоответствуетНормативу - Булево -
// * Комментарий - Строка
//
Функция СтруктураДанныхПоПоказателю()
	
	Результат = Новый Структура;
	Результат.Вставить("Номенклатура");
	Результат.Вставить("Показатель");
	
	Результат.Вставить("ЕдиницаИзмерения");
	Результат.Вставить("МинимальноеЗначение");
	Результат.Вставить("Базис");
	Результат.Вставить("МаксимальноеЗначение");
	Результат.Вставить("ПериодС");
	Результат.Вставить("ПериодПо");
	Результат.Вставить("ГОСТ");
		
	Результат.Вставить("ОтклонениеОтБазиса");
	Результат.Вставить("СоответствуетНормативу", Ложь);
	Результат.Вставить("Комментарий", "");
		
	Возврат Результат;
	
КонецФункции	

Функция ЧислоВИнтервале(Значение, ЛеваяГраница, ПраваяГраница)
	
	Если Значение >= ЛеваяГраница И Значение <= ПраваяГраница Тогда 
		Результат = Истина;
	Иначе
		Результат = Ложь;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции	

// Обработать текущие значения показателя.
//
// Параметры:
//  ЭлементРезультата - Структура - Элемент результата:
// * Номенклатура - СправочникСсылка.Номенклатура - Ссылка на номенклатуру
// * Показатель - СправочникСсылка.гкс_ПоказателиАнализовНоменклатуры - Ссылка на показатель анализа
// * ЕдиницаИзмерения - СправочникСсылка.УпаковкиЕдиницыИзмерения - Единица измерения показателя
// * МинимальноеЗначение - Число - Минимальное допустимое значение показателя
// * Базис - Число - Базисное значение показателя
// * МаксимальноеЗначение - Число - Максимальное допустимое значение показателя
// * ПериодС - Дата - Дата начала действия норматива
// * ПериодПо - Дата - Дата окончания действия норматива
// * ГОСТ - Строка - Наименование ГОСТа или стандарта
// * ОтклонениеОтБазиса - Число - Отклонение текущего значения от базиса
// * СоответствуетНормативу - Булево - Признак соответствия нормативу
// * Комментарий - Строка - Комментарий по результату проверки
//  ТекущиеЗначениеПоказателя - Соответствие, Неопределено - Текущие значения показателей
//  ДанныеВыборки - ВыборкаИзРезультатаЗапроса - Данные выборки из основного запроса
Процедура ОбработатьТекущиеЗначенияПоказателя(ЭлементРезультата, ТекущиеЗначениеПоказателя, ДанныеВыборки)
	
	ТекущееЗначение = ТекущиеЗначениеПоказателя.Получить(ДанныеВыборки.Показатель);
	Если ТекущееЗначение = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ЕстьМинЗначениеКонтрагента = ЗначениеЗаполнено(ДанныеВыборки.МинЗначениеКонтрагента);
	ТекущееЗначениеНеНулевое = ТекущееЗначение <> 0;
	
	Если ЕстьМинЗначениеКонтрагента И ТекущееЗначениеНеНулевое Тогда
		
		ЗначениеСоответствует = ТекущееЗначение < ДанныеВыборки.МинЗначениеКонтрагента;
		ЭлементРезультата.СоответствуетНормативу = НЕ ЗначениеСоответствует;
		
		Если ЗначениеСоответствует Тогда
			ЭлементРезультата.Комментарий = СтрШаблон("%1 (%2)",
					ДанныеВыборки.КомментарийКонтрагента,
					ДанныеВыборки.МинЗначениеКонтрагента);
		КонецЕсли;
		
	Иначе
		ЭлементРезультата.СоответствуетНормативу = ЧислоВИнтервале(ТекущееЗначение,
				ЭлементРезультата.МинимальноеЗначение, ЭлементРезультата.МаксимальноеЗначение);
	КонецЕсли;
	
	ЭлементРезультата.ОтклонениеОтБазиса = ТекущееЗначение - ЭлементРезультата.Базис;
	
КонецПроцедуры

// Получить параметры запроса для нормативной сертификации номенклатуры.
//
// Параметры:
//  ОбъектДокумента - ДокументОбъект.гкс_ЛабораторныйАнализ, Структура - Объект документа или структура с полями документа
//  ДополнительныеПараметры - Структура, Неопределено - Дополнительные параметры:
//   * Контрагент - СправочникСсылка.Контрагенты - Переопределение контрагента
//   * Показатель - СправочникСсылка.гкс_ПоказателиАнализовНоменклатуры - Конкретный показатель
//   * ТекущиеЗначениеПоказателя - Соответствие - Текущие значения показателей
//
// Возвращаемое значение:
//   Структура - Параметры запроса для функции РезультатыНормативнойСертификацииНоменклатуры:
//    * Период - Структура - Период с полями ДатаНачала, ДатаОкончания
//    * Номенклатура - СправочникСсылка.Номенклатура
//    * ТочкаМаршрута - СправочникСсылка.гкс_ТочкиМаршрута
//    * ВидПеревозки - ПеречислениеСсылка.гкс_ВидыПеревозки
//    * НазначениеИспользованияКачества - ПеречислениеСсылка.гкс_НазначенияИспользованияКачества
//    * Контрагент - СправочникСсылка.Контрагенты (если задан в дополнительных параметрах)
//    * Показатель - СправочникСсылка.гкс_ПоказателиАнализовНоменклатуры (если задан в дополнительных параметрах)
//    * ТекущиеЗначениеПоказателя - Соответствие (если задан в дополнительных параметрах)
//
Функция ПолучитьПараметрыЗапросаНормативнойСертификации(ОбъектДокумента, ДополнительныеПараметры = Неопределено)
	
	// Создаем базовую структуру периода
	Период = Новый Структура;
	Период.Вставить("ДатаНачала", ОбъектДокумента.Дата);
	Период.Вставить("ДатаОкончания", ОбъектДокумента.Дата);
	
	// Создаем базовую структуру параметров запроса
	ПараметрыЗапроса = Новый Структура;
	ПараметрыЗапроса.Вставить("Период", Период);
	ПараметрыЗапроса.Вставить("Номенклатура", ОбъектДокумента.Номенклатура);
	ПараметрыЗапроса.Вставить("ТочкаМаршрута", ОбъектДокумента.ТочкаМаршрута);
	ПараметрыЗапроса.Вставить("ВидПеревозки", ОбъектДокумента.гкс_ВидПеревозки);
	ПараметрыЗапроса.Вставить("НазначениеИспользованияКачества", ОбъектДокумента.гкс_НазначениеИспользованияКачества);
	
	// Дополнительный параметр для усиленного контроля
	ПараметрыЗапроса.Вставить("ДокументРегистрации", ОбъектДокумента.гкс_ДокументРегистрации);
	
	// Обрабатываем дополнительные параметры
	Если ТипЗнч(ДополнительныеПараметры) = Тип("Структура") Тогда
		ПараметрыЗапроса.Вставить("Контрагент", ДополнительныеПараметры.Контрагент);
		ПараметрыЗапроса.Вставить("Показатель", ДополнительныеПараметры.Показатель);
		ПараметрыЗапроса.Вставить("ТекущиеЗначениеПоказателя", ДополнительныеПараметры.ТекущиеЗначениеПоказателя);
	КонецЕсли;
	
	Возврат ПараметрыЗапроса;
	
КонецФункции

// Получить текст запроса для объединенного получения показателей.
//
// Возвращаемое значение:
//  Строка - Текст запроса с заполнителями для блоков
//
Функция УстановитьТекстЗапросаОбъединенногоПолученияПоказателей() Экспорт
	
	Возврат "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НормСерт.Номенклатура КАК Номенклатура,
	|	НормСерт.ПоказательАнализа КАК Показатель,
	|	МАКСИМУМ(НормСерт.ЗначениеПоказателя) КАК МинимальноеЗначение,
	|	МАКСИМУМ(НормСерт.МаксимальноеЗначение) КАК МаксимальноеЗначение,
	|	МАКСИМУМ(НормСерт.Базис) КАК Базис,
	|	МАКСИМУМ(НормСерт.ЕдиницаИзмерения) КАК ЕдиницаИзмерения,
	|	МАКСИМУМ(НормСерт.ПериодС) КАК ПериодС,
	|	МАКСИМУМ(НормСерт.ПериодПо) КАК ПериодПо,
	|	МАКСИМУМ(НормСерт.ГОСТ) КАК ГОСТ,
	|	0 КАК ОтклонениеОтБазиса,
	|	ЛОЖЬ КАК СоответствуетНормативу
	|ПОМЕСТИТЬ ВТ_ПоказателиНормСерт
	|ИЗ
	|	РегистрСведений.гкс_РезультатыНормативнойСертификацииНоменклатуры.СрезПоследних(&ДатаОкончания,
	|		Номенклатура = &Номенклатура
	|	И ТочкаМаршрута = &ТочкаМаршрута
	|	И ВидПеревозки = &ВидПеревозки
	|	И НазначениеИспользованияКачества = &НазначениеИспользованияКачества
	|	И &ТекстУсловияПоказательАнализа
	|	И (ПериодС <= &ДатаНачала
	|	ИЛИ ПериодС = ДАТАВРЕМЯ(1, 1, 1))
	|	И (ПериодПо >= НАЧАЛОПЕРИОДА(&ДатаОкончания, ДЕНЬ)
	|	ИЛИ ПериодПо = ДАТАВРЕМЯ(1, 1, 1))) КАК НормСерт
	|СГРУППИРОВАТЬ ПО
	|	НормСерт.Номенклатура,
	|	НормСерт.ПоказательАнализа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументРегистрацииНаПЛК.Номенклатура КАК Номенклатура,
	|	УсилКонтр.Показатель КАК Показатель,
	|	УсилКонтр.ЗначениеПоказателяМин КАК МинимальноеЗначение,
	|	УсилКонтр.ЗначениеПоказателяМакс КАК МаксимальноеЗначение,
	|	УсилКонтр.Базис КАК Базис,
	|	СправочникПоказателиАнализовНоменклатуры.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК ПериодС,
	|	ДАТАВРЕМЯ(1, 1, 1) КАК ПериодПо,
	|	"""" КАК ГОСТ,
	|	0 КАК ОтклонениеОтБазиса,
	|	ЛОЖЬ КАК СоответствуетНормативу
	|ПОМЕСТИТЬ ВТ_ПоказателиУсилКонтр
	|ИЗ
	|	РегистрСведений.гкс_ПоказателиУсиленногоКонтроляПоРегистрации КАК УсилКонтр
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.гкс_РегистрацияНаПЛК КАК ДокументРегистрацииНаПЛК
	|		ПО УсилКонтр.ДокументРегистрации = ДокументРегистрацииНаПЛК.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.гкс_ПоказателиАнализовНоменклатуры КАК СправочникПоказателиАнализовНоменклатуры
	|		ПО УсилКонтр.Показатель = СправочникПоказателиАнализовНоменклатуры.Ссылка
	|ГДЕ
	|	УсилКонтр.ДокументРегистрации = &ДокументРегистрации
	|	И УсилКонтр.НазначениеИспользования = &НазначениеИспользованияКачества
	|	И &ТекстУсловияПоказательУсиленногоКонтроля
	|	И &УсиленныйКонтроль
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВТ_ПоказателиНормСерт.Показатель КАК Показатель,
	|	ВТ_ПоказателиНормСерт.Номенклатура КАК Номенклатура,
	|	ВТ_ПоказателиНормСерт.МинимальноеЗначение КАК МинимальноеЗначение,
	|	ВТ_ПоказателиНормСерт.МаксимальноеЗначение КАК МаксимальноеЗначение,
	|	ВТ_ПоказателиНормСерт.Базис КАК Базис,
	|	ВТ_ПоказателиНормСерт.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВТ_ПоказателиНормСерт.ПериодС КАК ПериодС,
	|	ВТ_ПоказателиНормСерт.ПериодПо КАК ПериодПо,
	|	ВТ_ПоказателиНормСерт.ГОСТ КАК ГОСТ,
	|	ВТ_ПоказателиНормСерт.ОтклонениеОтБазиса КАК ОтклонениеОтБазиса,
	|	ВТ_ПоказателиНормСерт.СоответствуетНормативу КАК СоответствуетНормативу
	|ПОМЕСТИТЬ ВТ_Показатель
	|ИЗ
	|	ВТ_ПоказателиНормСерт КАК ВТ_ПоказателиНормСерт
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_ПоказателиУсилКонтр.Показатель,
	|	ВТ_ПоказателиУсилКонтр.Номенклатура,
	|	ВТ_ПоказателиУсилКонтр.МинимальноеЗначение,
	|	ВТ_ПоказателиУсилКонтр.МаксимальноеЗначение,
	|	ВТ_ПоказателиУсилКонтр.Базис,
	|	ВТ_ПоказателиУсилКонтр.ЕдиницаИзмерения,
	|	ВТ_ПоказателиУсилКонтр.ПериодС,
	|	ВТ_ПоказателиУсилКонтр.ПериодПо,
	|	ВТ_ПоказателиУсилКонтр.ГОСТ,
	|	ВТ_ПоказателиУсилКонтр.ОтклонениеОтБазиса,
	|	ВТ_ПоказателиУсилКонтр.СоответствуетНормативу
	|ИЗ
	|	ВТ_ПоказателиУсилКонтр КАК ВТ_ПоказателиУсилКонтр
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Показатель.Показатель КАК Показатель,
	|	ВТ_Показатель.Номенклатура КАК Номенклатура,
	|	МАКСИМУМ(ВТ_Показатель.МинимальноеЗначение) КАК МинимальноеЗначение,
	|	МИНИМУМ(ВТ_Показатель.МаксимальноеЗначение) КАК МаксимальноеЗначение,
	|	МАКСИМУМ(ВТ_Показатель.Базис) КАК Базис,
	|	МАКСИМУМ(ВТ_Показатель.ЕдиницаИзмерения) КАК ЕдиницаИзмерения,
	|	МАКСИМУМ(ВТ_Показатель.ПериодС) КАК ПериодС,
	|	МАКСИМУМ(ВТ_Показатель.ПериодПо) КАК ПериодПо,
	|	МАКСИМУМ(ВТ_Показатель.ГОСТ) КАК ГОСТ,
	|	МАКСИМУМ(ВТ_Показатель.ОтклонениеОтБазиса) КАК ОтклонениеОтБазиса,
	|	МАКСИМУМ(ВТ_Показатель.СоответствуетНормативу) КАК СоответствуетНормативу
	|ПОМЕСТИТЬ ВТРезультатыНСН
	|ИЗ
	|	ВТ_Показатель КАК ВТ_Показатель
	|СГРУППИРОВАТЬ ПО
	|	ВТ_Показатель.Показатель,
	|	ВТ_Показатель.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МинимальныеПоказателиКачестваПриемкиСрезПоследних.Показатель КАК Показатель,
	|	МинимальныеПоказателиКачестваПриемкиСрезПоследних.ЗначениеПоказателя КАК ЗначениеПоказателя,
	|	МинимальныеПоказателиКачестваПриемкиСрезПоследних.ОстатокДляПриемки КАК ОстатокДляПриемки,
	|	МинимальныеПоказателиКачестваПриемкиСрезПоследних.ШаблонКомментария КАК Комментарий
	|ПОМЕСТИТЬ ВТМинимальныеПоказатели
	|ИЗ
	|	РегистрСведений.гкс_МинимальныеПоказателиКачестваПриемки.СрезПоследних(&ДатаНачала, Контрагент = &Контрагент
	|	И Номенклатура = &Номенклатура
	|	И &НазначениеИспользованияКачества <> ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПриемкаКомпозит)
	|	И Показатель В
	|		(ВЫБРАТЬ
	|			ВТРезультатыНСН.Показатель КАК Показатель
	|		ИЗ
	|			ВТРезультатыНСН КАК ВТРезультатыНСН)) КАК МинимальныеПоказателиКачестваПриемкиСрезПоследних
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Показатель
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТРезультатыНСН.Показатель КАК Показатель,
	|	ВТРезультатыНСН.Номенклатура КАК Номенклатура,
	|	ВТРезультатыНСН.МинимальноеЗначение КАК МинимальноеЗначение,
	|	ВТРезультатыНСН.МаксимальноеЗначение КАК МаксимальноеЗначение,
	|	ВТРезультатыНСН.Базис КАК Базис,
	|	ВТРезультатыНСН.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ВТРезультатыНСН.ПериодС КАК ПериодС,
	|	ВТРезультатыНСН.ПериодПо КАК ПериодПо,
	|	ВТРезультатыНСН.ГОСТ КАК ГОСТ,
	|	ВТРезультатыНСН.ОтклонениеОтБазиса КАК ОтклонениеОтБазиса,
	|	ВТРезультатыНСН.СоответствуетНормативу КАК СоответствуетНормативу,
	|	ЕСТЬNULL(ВТМинимальныеПоказатели.ЗначениеПоказателя, 0) КАК МинЗначениеКонтрагента,
	|	ЕСТЬNULL(ВТМинимальныеПоказатели.ОстатокДляПриемки, 0) КАК ОстатокДляПриемки,
	|	ЕСТЬNULL(ВТМинимальныеПоказатели.Комментарий, """") КАК КомментарийКонтрагента
	|ИЗ
	|	ВТРезультатыНСН КАК ВТРезультатыНСН
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТМинимальныеПоказатели КАК ВТМинимальныеПоказатели
	|		ПО ВТРезультатыНСН.Показатель = ВТМинимальныеПоказатели.Показатель";
	
КонецФункции

#КонецОбласти


