# Детальный анализ модулей: АРМ Промежуточный Композит

**Дата**: 2025-10-29
**Связанный документ**: 01_TASK_OVERVIEW_AND_ARCHITECTURE.md

---

## 1. ObjectModule.bsl - Серверная логика (312 строк)

### 1.1 Структура модуля

```
ObjectModule.bsl
├── ТекстЗапросаДанныеДляДетальныхЗаписей() (строки 7-139)
├── ДанныеДляСписокПроизвольныйКомпозит() (строки 141-221)
├── ДанныеДляСписокПромежуточныеПробы() (строки 223-274)
└── ДанныеДляСписокРегистрацииПромежуточныхПроб() (строки 276-312)
```

### 1.2 Функция ТекстЗапросаДанныеДляДетальныхЗаписей()

**Назначение**: Формирование текста SQL-запроса для получения детальных данных регистраций

**Ключевые элементы**:

1. **Временная таблица ВТ_Регистрации** (строки 10-49):
```sql
ВЫБРАТЬ
    Регистрации.Ссылка КАК Регистрация,
    Регистрации.Дата КАК ДатаРегистрации,
    Регистрации.Номер,
    Регистрации.Организация,
    Регистрации.Контрагент,
    Регистрации.Номенклатура,
    Регистрации.ПЛК,
    Регистрации.ПроизводственныеСутки,
    ПоказателиКачества.Показатель,
    ПоказателиКачества.СостояниеКачества,
    СоставГруппТС.ГруппаТС,
    СоставГруппТС.ИдентификаторГруппыТС
ПОМЕСТИТЬ ВТ_Регистрации
ИЗ
    Документ.гкс_РегистрацияНаПЛК КАК Регистрации
        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.гкс_ПоказателиКачестваУсиленногоКонтроля КАК ПоказателиКачества
            ПО Регистрации.Ссылка = ПоказателиКачества.Регистрация
            И ПоказателиКачества.НазначениеИспользования =
                ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит)
        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.гкс_СоставГруппТранспорта КАК СоставГруппТС
            ПО Регистрации.Ссылка = СоставГруппТС.Регистрация
ГДЕ
    Регистрации.Проведен = ИСТИНА
    И Регистрации.Организация В (&МассивОрганизаций)
    И Регистрации.ПЛК В (&МассивПЛК)
    И Регистрации.ПроизводственныеСутки МЕЖДУ &ДатаНачала И &ДатаОкончания
    И (ПоказателиКачества.СостояниеКачества В (
            ЗНАЧЕНИЕ(Перечисление.гкс_СостоянияКачестваУсиленногоКонтроля.ПустаяСсылка),
            ЗНАЧЕНИЕ(Перечисление.гкс_СостоянияКачестваУсиленногоКонтроля.ОтборПроб))
        ИЛИ &ПоказыватьВсе = ИСТИНА)
```

**Особенности**:
- Фильтрация только проведенных документов
- Соединение с двумя регистрами сведений через LEFT JOIN
- Фильтрация по назначению использования = "ПромежуточныйКомпозит"
- Условная фильтрация по состоянию качества (параметр &ПоказыватьВсе)

2. **Временная таблица ВТ_КомпозитныеПробы** (строки 53-72):
```sql
ВЫБРАТЬ
    КомпозитныеПробы.ДокументПроба,
    КомпозитныеПробы.Регистрация,
    КомпозитныеПробы.ТипПробы
ПОМЕСТИТЬ ВТ_КомпозитныеПробы
ИЗ
    РегистрСведений.гкс_КомпозитныеПробы КАК КомпозитныеПробы
        ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Регистрации КАК ВТ_Регистрации
            ПО КомпозитныеПробы.Регистрация = ВТ_Регистрации.Регистрация
ГДЕ
    КомпозитныеПробы.ТипПробы = ЗНАЧЕНИЕ(Перечисление.гкс_ТипыПроб.Композитная)
    И КомпозитныеПробы.ДокументПроба.НазначениеИспользованияКачества =
        ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит)
```

**Особенности**:
- INNER JOIN с ВТ_Регистрации для оптимизации
- Двойная фильтрация: по типу пробы И по назначению использования

3. **Временная таблица ВТ_ЕдиничныеПробы** (строки 76-92):
```sql
ВЫБРАТЬ
    КомпозитныеПробы.ДокументПроба,
    КомпозитныеПробы.Регистрация
ПОМЕСТИТЬ ВТ_ЕдиничныеПробы
ИЗ
    РегистрСведений.гкс_КомпозитныеПробы КАК КомпозитныеПробы
        ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Регистрации КАК ВТ_Регистрации
            ПО КомпозитныеПробы.Регистрация = ВТ_Регистрации.Регистрация
ГДЕ
    КомпозитныеПробы.ТипПробы = ЗНАЧЕНИЕ(Перечисление.гкс_ТипыПроб.Единичная)
```

4. **Финальный SELECT** (строки 96-139):
```sql
ВЫБРАТЬ
    ВТ_Регистрации.Регистрация,
    ВТ_Регистрации.Номенклатура КАК Номенклатура,
    ВТ_Регистрации.Контрагент КАК Контрагент,
    ВТ_Регистрации.Организация,
    ВТ_Регистрации.ПЛК,
    ВТ_Регистрации.ГруппаТС,
    ВТ_Регистрации.Показатель,
    ВТ_Регистрации.СостояниеКачества,
    ВЫБОР
        КОГДА ВТ_КомпозитныеПробы.ДокументПроба ЕСТЬ NULL
            ТОГДА 0
        ИНАЧЕ 1
    КОНЕЦ КАК ЕстьКомпозитнаяПроба,
    ВТ_КомпозитныеПробы.ДокументПроба КАК ДокументКомпозитнаяПроба,
    ВЫБОР
        КОГДА ВТ_ЕдиничныеПробы.ДокументПроба ЕСТЬ NULL
            ТОГДА 0
        ИНАЧЕ 1
    КОНЕЦ КАК ЕстьЕдиничнаяПроба,
    ВТ_ЕдиничныеПробы.ДокументПроба КАК ДокументЕдиничнаяПроба
ИЗ
    ВТ_Регистрации КАК ВТ_Регистрации
        ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КомпозитныеПробы КАК ВТ_КомпозитныеПробы
            ПО ВТ_Регистрации.Регистрация = ВТ_КомпозитныеПробы.Регистрация
            И ВТ_Регистрации.Показатель = ВТ_КомпозитныеПробы.Показатель
        ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ЕдиничныеПробы КАК ВТ_ЕдиничныеПробы
            ПО ВТ_Регистрации.Регистрация = ВТ_ЕдиничныеПробы.Регистрация
УПОРЯДОЧИТЬ ПО
    Номенклатура,
    Контрагент,
    ГруппаТС,
    Показатель
```

**Особенности**:
- Использование CASE для флагов наличия проб
- Двойное LEFT JOIN для композитных и единичных проб
- Сортировка для группировки похожих записей

### 1.3 Функция ДанныеДляСписокПроизвольныйКомпозит()

**Назначение**: Получение данных для страницы "Произвольный композит"

**Код** (строки 141-221):
```bsl
Функция ДанныеДляСписокПроизвольныйКомпозит(Параметры) Экспорт

    Запрос = Новый Запрос;
    Запрос.Текст = ТекстЗапросаДанныеДляДетальныхЗаписей();

    // Установка параметров из структуры
    Запрос.УстановитьПараметр("МассивОрганизаций", Параметры.МассивОрганизаций);
    Запрос.УстановитьПараметр("МассивПЛК", Параметры.МассивПЛК);
    Запрос.УстановитьПараметр("ДатаНачала", Параметры.ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", Параметры.ДатаОкончания);
    Запрос.УстановитьПараметр("ПоказыватьВсе", Параметры.ПоказыватьВсе);

    Результат = Запрос.Выполнить();
    Возврат Результат.Выгрузить();

КонецФункции
```

**Входные параметры** (Структура):
- `МассивОрганизаций` - массив организаций для отбора
- `МассивПЛК` - массив ПЛК для отбора
- `ДатаНачала` - начало периода производственных суток
- `ДатаОкончания` - конец периода
- `ПоказыватьВсе` - флаг показа всех регистраций

**Возвращает**: ТаблицаЗначений с колонками:
- Регистрация
- Номенклатура
- Контрагент
- Организация
- ПЛК
- ГруппаТС
- Показатель
- СостояниеКачества
- ЕстьКомпозитнаяПроба (0/1)
- ДокументКомпозитнаяПроба
- ЕстьЕдиничнаяПроба (0/1)
- ДокументЕдиничнаяПроба

### 1.4 Функция ДанныеДляСписокПромежуточныеПробы()

**Назначение**: Получение списка существующих промежуточных композитных проб

**Код** (строки 223-274):
```bsl
Функция ДанныеДляСписокПромежуточныеПробы(Параметры) Экспорт

    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    ФормированиеНомераПробы.Ссылка КАК ДокументПроба,
    |    ФормированиеНомераПробы.Дата,
    |    ФормированиеНомераПробы.Номер,
    |    ФормированиеНомераПробы.Организация,
    |    ФормированиеНомераПробы.ПЛК,
    |    ФормированиеНомераПробы.Номенклатура,
    |    ФормированиеНомераПробы.НомерПробы,
    |    ФормированиеНомераПробы.ЛабораторныйАнализ
    |ИЗ
    |    Документ.гкс_ФормированиеНомераПробы КАК ФормированиеНомераПробы
    |ГДЕ
    |    ФормированиеНомераПробы.НазначениеИспользованияКачества =
    |        ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит)
    |    И ФормированиеНомераПробы.ТипПробы =
    |        ЗНАЧЕНИЕ(Перечисление.гкс_ТипыПроб.Композитная)
    |    И ФормированиеНомераПробы.Организация В (&МассивОрганизаций)
    |    И ФормированиеНомераПробы.ПЛК В (&МассивПЛК)
    |    И ФормированиеНомераПробы.ПроизводственныеСутки МЕЖДУ &ДатаНачала И &ДатаОкончания
    |УПОРЯДОЧИТЬ ПО
    |    Дата УБЫВ";

    Запрос.УстановитьПараметр("МассивОрганизаций", Параметры.МассивОрганизаций);
    Запрос.УстановитьПараметр("МассивПЛК", Параметры.МассивПЛК);
    Запрос.УстановитьПараметр("ДатаНачала", Параметры.ДатаНачала);
    Запрос.УстановитьПараметр("ДатаОкончания", Параметры.ДатаОкончания);

    Результат = Запрос.Выполнить();
    Возврат Результат.Выгрузить();

КонецФункции
```

**Особенности**:
- Простой запрос без временных таблиц
- Двойная фильтрация по назначению использования и типу пробы
- Сортировка по дате (новые первыми)

### 1.5 Функция ДанныеДляСписокРегистрацииПромежуточныхПроб()

**Назначение**: Получение регистраций, входящих в промежуточные композитные пробы

**Код** (строки 276-312):
```bsl
Функция ДанныеДляСписокРегистрацииПромежуточныхПроб(ДокументПроба) Экспорт

    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    КомпозитныеПробы.Регистрация,
    |    КомпозитныеПробы.Регистрация.Номер КАК НомерРегистрации,
    |    КомпозитныеПробы.Регистрация.Дата КАК ДатаРегистрации,
    |    КомпозитныеПробы.Регистрация.Номенклатура КАК Номенклатура,
    |    КомпозитныеПробы.Регистрация.Контрагент КАК Контрагент
    |ИЗ
    |    РегистрСведений.гкс_КомпозитныеПробы КАК КомпозитныеПробы
    |ГДЕ
    |    КомпозитныеПробы.ДокументПроба = &ДокументПроба
    |УПОРЯДОЧИТЬ ПО
    |    ДатаРегистрации УБЫВ";

    Запрос.УстановитьПараметр("ДокументПроба", ДокументПроба);

    Результат = Запрос.Выполнить();
    Возврат Результат.Выгрузить();

КонецФункции
```

**Особенности**:
- Получение данных через точечную нотацию (Регистрация.Номер)
- Используется для отображения детализации композитной пробы

---

## 2. Forms/Форма/Module.bsl - Основная форма (601 строка)

### 2.1 Структура модуля

```
Forms/Форма/Module.bsl
├── Переменные формы (строки 1-10)
├── ПриСозданииНаСервере() (строки 12-45)
├── ОбновлениеОтображенияДанных() (строки 47-95)
├── Обработчики страниц (строки 97-180)
│   ├── ТаблицаПроизвольныйКомпозитПриАктивизацииСтроки()
│   ├── ТаблицаПроизвольныйКомпозитПриИзмененииФлажка()
│   └── ТаблицаПромежуточныеПробыПриАктивизацииСтроки()
├── Команды формирования (строки 182-385)
│   ├── КомандаСформироватьПробыПроизвольныйКомпозит()
│   ├── КомандаОткрытьДокументПробы()
│   └── КомандаПечатьЭтикетки()
├── Функции валидации (строки 387-450)
│   ├── ПроверитьСовпадениеДанныхСПервойСтрокой()
│   └── ПроверитьНаличиеВыделенныхСтрок()
├── Навигация по датам (строки 452-520)
│   ├── КомандаДобавитьДень()
│   └── КомандаВычестьДень()
└── Вспомогательные функции (строки 522-601)
```

### 2.2 ПриСозданииНаСервере() - Инициализация формы

**Код** (ключевые фрагменты):
```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    // Установка начальных значений
    Если НЕ ЗначениеЗаполнено(ПроизводственныеСутки) Тогда
        ПроизводственныеСутки = ТекущаяДата();
    КонецЕсли;

    // Определение режима работы
    Если Параметры.Свойство("ПромежуточныйКомпозит")
        И Параметры.ПромежуточныйКомпозит = Истина Тогда

        РежимПромежуточныйКомпозит = Истина;
        Элементы.Страницы.ТекущаяСтраница = Элементы.СтраницаПромежуточныеПробы;
    Иначе
        РежимПромежуточныйКомпозит = Ложь;
        Элементы.Страницы.ТекущаяСтраница = Элементы.СтраницаПроизвольныйКомпозит;
    КонецЕсли;

    // Заполнение отборов по умолчанию
    ЗаполнитьМассивОрганизаций();
    ЗаполнитьМассивПЛК();

    // Загрузка данных
    ОбновлениеОтображенияДанных();

КонецПроцедуры
```

**Логика**:
1. Установка производственных суток (по умолчанию = текущая дата)
2. Определение режима работы (произвольный или промежуточный композит)
3. Заполнение отборов (организации, ПЛК)
4. Первичная загрузка данных

### 2.3 ОбновлениеОтображенияДанных() - Обновление данных

**Код**:
```bsl
&НаСервере
Процедура ОбновлениеОтображенияДанных()

    // Формирование параметров запроса
    ПараметрыЗапроса = Новый Структура;
    ПараметрыЗапроса.Вставить("МассивОрганизаций", МассивОрганизаций);
    ПараметрыЗапроса.Вставить("МассивПЛК", МассивПЛК);
    ПараметрыЗапроса.Вставить("ДатаНачала", НачалоДня(ПроизводственныеСутки));
    ПараметрыЗапроса.Вставить("ДатаОкончания", КонецДня(ПроизводственныеСутки));
    ПараметрыЗапроса.Вставить("ПоказыватьВсе", ПоказыватьВсе);

    Если РежимПромежуточныйКомпозит Тогда
        // Обновление страницы промежуточных проб
        ТаблицаПромежуточныеПробы.Загрузить(
            РеквизитФормыВЗначение("Объект")
                .ДанныеДляСписокПромежуточныеПробы(ПараметрыЗапроса)
        );
    Иначе
        // Обновление страницы произвольного композита
        ТаблицаПроизвольныйКомпозит.Загрузить(
            РеквизитФормыВЗначение("Объект")
                .ДанныеДляСписокПроизвольныйКомпозит(ПараметрыЗапроса)
        );
    КонецЕсли;

КонецПроцедуры
```

**Логика**:
- Формирование параметров из отборов формы
- Вызов соответствующей функции объекта обработки
- Загрузка результатов в табличную часть формы

### 2.4 ТаблицаПроизвольныйКомпозитПриИзмененииФлажка() - Автоматическое выделение

**Код** (строки 125-180):
```bsl
&НаКлиенте
Процедура ТаблицаПроизвольныйКомпозитПриИзмененииФлажка(Элемент)

    ТекущиеДанные = Элементы.ТаблицаПроизвольныйКомпозит.ТекущиеДанные;
    Если ТекущиеДанные = Неопределено Тогда
        Возврат;
    КонецЕсли;

    // Получаем ключевые значения текущей строки
    ТекущаяГруппаТС = ТекущиеДанные.ГруппаТС;
    ТекущийПоказатель = ТекущиеДанные.Показатель;
    ТекущаяОтметка = ТекущиеДанные.Отметка;

    // Проходим по всем строкам таблицы
    Для Каждого СтрокаТаблицы Из ТаблицаПроизвольныйКомпозит Цикл

        // Если совпадают ГруппаТС и Показатель
        Если СтрокаТаблицы.ГруппаТС = ТекущаяГруппаТС
            И СтрокаТаблицы.Показатель = ТекущийПоказатель Тогда

            // Устанавливаем такую же отметку
            СтрокаТаблицы.Отметка = ТекущаяОтметка;

        КонецЕсли;

    КонецЦикла;

КонецПроцедуры
```

**Алгоритм**:
1. Получить текущую строку
2. Извлечь ГруппаТС и Показатель
3. Пройти по всем строкам таблицы
4. Для строк с совпадающими ГруппаТС и Показателем:
   - Установить такую же отметку (выделить/снять выделение)

**Результат**: Автоматическое массовое выделение/снятие выделения связанных строк

### 2.5 КомандаСформироватьПробыПроизвольныйКомпозит() - Формирование проб

**Код** (ключевые фрагменты, строки 182-300):
```bsl
&НаКлиенте
Процедура КомандаСформироватьПробыПроизвольныйКомпозит(Команда)

    // 1. Проверка наличия выделенных строк
    Если НЕ ПроверитьНаличиеВыделенныхСтрок() Тогда
        Возврат;
    КонецЕсли;

    // 2. Сбор выделенных строк
    МассивВыделенныхСтрок = Новый Массив;
    ПерваяОтмеченнаяСтрока = Неопределено;

    Для Каждого СтрокаТаблицы Из ТаблицаПроизвольныйКомпозит Цикл
        Если СтрокаТаблицы.Отметка = Истина Тогда

            Если ПерваяОтмеченнаяСтрока = Неопределено Тогда
                ПерваяОтмеченнаяСтрока = СтрокаТаблицы;
            Иначе
                // 3. Валидация совпадения данных
                Если НЕ ПроверитьСовпадениеДанныхСПервойСтрокой(
                    СтрокаТаблицы, ПерваяОтмеченнаяСтрока) Тогда
                    Возврат;
                КонецЕсли;
            КонецЕсли;

            МассивВыделенныхСтрок.Добавить(СтрокаТаблицы);

        КонецЕсли;
    КонецЦикла;

    // 4. Проверка наличия существующей композитной пробы
    ДокументКомпозитнаяПроба = ПерваяОтмеченнаяСтрока.ДокументКомпозитнаяПроба;

    // 5. Валидация возможности формирования
    Если ЗначениеЗаполнено(ПерваяОтмеченнаяСтрока.СостояниеКачества)
        И ПерваяОтмеченнаяСтрока.СостояниеКачества <>
            ПредопределенноеЗначение("Перечисление.гкс_СостоянияКачестваУсиленногоКонтроля.ОтборПроб") Тогда

        ТекстСообщения = "Анализы для выбранных регистраций уже выполнены. " +
                         "Формирование новой композитной пробы невозможно.";
        ПоказатьПредупреждение(, ТекстСообщения);
        Возврат;
    КонецЕсли;

    // 6. Формирование параметров для открытия формы
    ПараметрыФормы = Новый Структура;
    ПараметрыФормы.Вставить("Организация", ПерваяОтмеченнаяСтрока.Организация);
    ПараметрыФормы.Вставить("ПЛК", ПерваяОтмеченнаяСтрока.ПЛК);
    ПараметрыФормы.Вставить("Номенклатура", ПерваяОтмеченнаяСтрока.Номенклатура);
    ПараметрыФормы.Вставить("Контрагент", ПерваяОтмеченнаяСтрока.Контрагент);
    ПараметрыФормы.Вставить("МассивРегистраций", МассивРегистраций());
    ПараметрыФормы.Вставить("МассивПоказателей", МассивПоказателей());

    // 7. Открытие формы
    Если ЗначениеЗаполнено(ДокументКомпозитнаяПроба) Тогда
        // Открыть существующий документ
        ИмяФормыДокумента = "Документ.гкс_ФормированиеНомераПробы.Форма.ФормаДокумента";
        ПараметрыФормы.Вставить("Ключ", ДокументКомпозитнаяПроба);
    Иначе
        // Открыть форму создания нового
        ИмяФормыДокумента = "Обработка.гкс_АРМПромежуточныйКомпозит.Форма.ФормаФормированиеКомпозитнойФормы";
    КонецЕсли;

    ОткрытьФорму(ИмяФормыДокумента, ПараметрыФормы, ЭтаФорма);

КонецПроцедуры
```

**Алгоритм**:
1. Проверка наличия выделенных строк
2. Сбор выделенных строк в массив
3. Валидация совпадения номенклатуры, контрагента, организации
4. Проверка существования композитной пробы
5. Валидация состояния качества УК
6. Формирование параметров для формы
7. Открытие соответствующей формы (создание нового или редактирование существующего)

### 2.6 ПроверитьСовпадениеДанныхСПервойСтрокой() - Валидация строк

**Код** (строки 387-450):
```bsl
&НаКлиенте
Функция ПроверитьСовпадениеДанныхСПервойСтрокой(ТекущиеДанные, ПерваяОтмеченнаяСтрока)

    // Проверка номенклатуры
    Если ТекущиеДанные.Номенклатура <> ПерваяОтмеченнаяСтрока.Номенклатура Тогда
        ТекстСообщения = СтрШаблон(
            НСтр("ru = 'Выбранная строка имеет отличающиеся данные от первой отмеченной строки:%1- Номенклатура'"),
            Символы.ПС);
        ПоказатьПредупреждение(, ТекстСообщения);
        Возврат Ложь;
    КонецЕсли;

    // Проверка контрагента (с запросом подтверждения)
    Если ТекущиеДанные.Контрагент <> ПерваяОтмеченнаяСтрока.Контрагент Тогда
        ТекстВопроса = СтрШаблон(
            НСтр("ru = 'Выбранная строка имеет отличающегося контрагента. Продолжить?'"));

        Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
        Если Ответ = КодВозвратаДиалога.Нет Тогда
            Возврат Ложь;
        КонецЕсли;
    КонецЕсли;

    // Проверка организации (с запросом подтверждения)
    Если ТекущиеДанные.Организация <> ПерваяОтмеченнаяСтрока.Организация Тогда
        ТекстВопроса = СтрШаблон(
            НСтр("ru = 'Выбранная строка имеет отличающуюся организацию. Продолжить?'"));

        Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
        Если Ответ = КодВозвратаДиалога.Нет Тогда
            Возврат Ложь;
        КонецЕсли;
    КонецЕсли;

    Возврат Истина;

КонецФункции
```

**Логика проверок**:
1. **Номенклатура**: Строгая проверка, запрещено различие
2. **Контрагент**: Мягкая проверка, запрос подтверждения у пользователя
3. **Организация**: Мягкая проверка, запрос подтверждения

### 2.7 Навигация по производственным суткам

**КомандаДобавитьДень()** (строки 452-475):
```bsl
&НаКлиенте
Процедура КомандаДобавитьДень(Команда)

    ПроизводственныеСутки = ПроизводственныеСутки + 86400; // +1 день в секундах
    ОбновлениеОтображенияДанных();

КонецПроцедуры
```

**КомандаВычестьДень()** (строки 477-500):
```bsl
&НаКлиенте
Процедура КомандаВычестьДень(Команда)

    ПроизводственныеСутки = ПроизводственныеСутки - 86400; // -1 день в секундах
    ОбновлениеОтображенияДанных();

КонецПроцедуры
```

---

## 3. Forms/ФормаФормированиеКомпозитнойФормы/Module.bsl (363 строки)

### 3.1 Структура модуля

```
ФормаФормированиеКомпозитнойФормы/Module.bsl
├── ПриСозданииНаСервере() (строки 1-85)
├── ЗагрузитьПоказателиИзНормативнойАттестации() (строки 87-150)
├── ДобавитьПоказатель() (строки 152-210)
├── УдалитьПоказатель() (строки 212-240)
├── СформироватьДокумент() (строки 242-335)
└── ПроверитьНаличиеПоказателяВНорме() (строки 337-363)
```

### 3.2 ПриСозданииНаСервере() - Инициализация

**Код** (ключевые фрагменты, строки 1-85):
```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    // Получение параметров из вызывающей формы
    Если Параметры.Свойство("Организация") Тогда
        Объект.Организация = Параметры.Организация;
    КонецЕсли;

    Если Параметры.Свойство("ПЛК") Тогда
        Объект.ПЛК = Параметры.ПЛК;
    КонецЕсли;

    Если Параметры.Свойство("Номенклатура") Тогда
        Объект.Номенклатура = Параметры.Номенклатура;
    КонецЕсли;

    Если Параметры.Свойство("Контрагент") Тогда
        Объект.Контрагент = Параметры.Контрагент;
    КонецЕсли;

    Если Параметры.Свойство("МассивРегистраций") Тогда
        // Заполнение табличной части регистраций
        Для Каждого Регистрация Из Параметры.МассивРегистраций Цикл
            НоваяСтрока = Объект.Регистрации.Добавить();
            НоваяСтрока.Регистрация = Регистрация;
        КонецЦикла;
    КонецЕсли;

    // Автоматическая загрузка показателей из нормативной аттестации
    ЗагрузитьПоказателиИзНормативнойАттестации();

КонецПроцедуры
```

### 3.3 ЗагрузитьПоказателиИзНормативнойАттестации()

**Код** (строки 87-150):
```bsl
&НаСервере
Процедура ЗагрузитьПоказателиИзНормативнойАттестации()

    // Очистка текущих показателей
    Объект.Показатели.Очистить();

    // Получение нормативной аттестации для номенклатуры
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |    НормативнаяАттестация.Показатель КАК Показатель,
    |    НормативнаяАттестация.НазначениеИспользования
    |ИЗ
    |    РегистрСведений.гкс_НормативнаяАттестацияНоменклатуры КАК НормативнаяАттестация
    |ГДЕ
    |    НормативнаяАттестация.Номенклатура = &Номенклатура
    |    И НормативнаяАттестация.НазначениеИспользования =
    |        ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит)
    |УПОРЯДОЧИТЬ ПО
    |    Показатель.Наименование";

    Запрос.УстановитьПараметр("Номенклатура", Объект.Номенклатура);

    Результат = Запрос.Выполнить();
    Выборка = Результат.Выбрать();

    // Заполнение таблицы показателей
    Пока Выборка.Следующий() Цикл
        НоваяСтрока = Объект.Показатели.Добавить();
        НоваяСтрока.Показатель = Выборка.Показатель;
    КонецЦикла;

    // Сообщение о количестве загруженных показателей
    ТекстСообщения = СтрШаблон(
        НСтр("ru = 'Загружено показателей из нормативной аттестации: %1'"),
        Объект.Показатели.Количество());
    Сообщить(ТекстСообщения);

КонецПроцедуры
```

**Логика**:
1. Очистка текущего списка показателей
2. Запрос показателей из РС.гкс_НормативнаяАттестацияНоменклатуры
3. Фильтрация по назначению использования = "ПромежуточныйКомпозит"
4. Заполнение табличной части формы
5. Информирование пользователя о количестве загруженных показателей

### 3.4 СформироватьДокумент() - Создание документов

**Код** (ключевые фрагменты, строки 242-335):
```bsl
&НаКлиенте
Процедура СформироватьДокумент(Команда)

    // 1. Валидация наличия показателей
    Если Объект.Показатели.Количество() = 0 Тогда
        ПоказатьПредупреждение(, НСтр("ru = 'Не указаны показатели для анализа!'"));
        Возврат;
    КонецЕсли;

    // 2. Формирование массива показателей
    МассивПоказателей = Новый Массив;
    Для Каждого СтрокаПоказатель Из Объект.Показатели Цикл
        Если ЗначениеЗаполнено(СтрокаПоказатель.Показатель) Тогда
            МассивПоказателей.Добавить(СтрокаПоказатель.Показатель);
        КонецЕсли;
    КонецЦикла;

    // 3. Формирование массива регистраций
    МассивРегистраций = Новый Массив;
    Для Каждого СтрокаРегистрация Из Объект.Регистрации Цикл
        Если ЗначениеЗаполнено(СтрокаРегистрация.Регистрация) Тогда
            МассивРегистраций.Добавить(СтрокаРегистрация.Регистрация);
        КонецЕсли;
    КонецЦикла;

    // 4. Формирование параметров создания документа
    ПараметрыСоздания = Новый Структура;
    ПараметрыСоздания.Вставить("Организация", Объект.Организация);
    ПараметрыСоздания.Вставить("ПЛК", Объект.ПЛК);
    ПараметрыСоздания.Вставить("Номенклатура", Объект.Номенклатура);
    ПараметрыСоздания.Вставить("Контрагент", Объект.Контрагент);
    ПараметрыСоздания.Вставить("МассивРегистраций", МассивРегистраций);
    ПараметрыСоздания.Вставить("ТипПробы",
        ПредопределенноеЗначение("Перечисление.гкс_ТипыПроб.Композитная"));

    // 5. Параметры для лабораторного анализа
    ПараметрыСозданияАнализа = Новый Структура;
    ПараметрыСозданияАнализа.Вставить("МассивПоказателей", МассивПоказателей);
    ПараметрыСозданияАнализа.Вставить("НазначениеИспользованияКачества",
        ПредопределенноеЗначение("Перечисление.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит"));

    // 6. Вызов серверной процедуры создания
    СформироватьДокументНаСервере(ПараметрыСоздания, ПараметрыСозданияАнализа);

    // 7. Закрытие формы
    Закрыть();

КонецПроцедуры

&НаСервере
Процедура СформироватьДокументНаСервере(ПараметрыСоздания, ПараметрыСозданияАнализа)

    // Создание документа гкс_ФормированиеНомераПробы
    НовыйДокумент = Документы.гкс_ФормированиеНомераПробы.ДокументПромежуточногоКомпозита(
        ПараметрыСоздания,
        ПараметрыСозданияАнализа);

    // Открытие созданного документа
    Если ЗначениеЗаполнено(НовыйДокумент) Тогда
        ПоказатьЗначение(, НовыйДокумент);
    КонецЕсли;

КонецПроцедуры
```

**Алгоритм**:
1. Валидация наличия показателей
2. Формирование массива показателей из таблицы
3. Формирование массива регистраций
4. Подготовка параметров для документа формирования номера пробы
5. Подготовка параметров для лабораторного анализа с назначением "ПромежуточныйКомпозит"
6. Вызов серверной функции создания документа
7. Открытие созданного документа
8. Закрытие формы

### 3.5 ПроверитьНаличиеПоказателяВНорме() - Валидация показателя

**Код** (строки 337-363):
```bsl
&НаСервере
Функция ПроверитьНаличиеПоказателяВНорме(Показатель)

    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |    ИСТИНА КАК Результат
    |ИЗ
    |    РегистрСведений.гкс_НормативнаяАттестацияНоменклатуры КАК НормативнаяАттестация
    |ГДЕ
    |    НормативнаяАттестация.Номенклатура = &Номенклатура
    |    И НормативнаяАттестация.Показатель = &Показатель
    |    И НормативнаяАттестация.НазначениеИспользования =
    |        ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит)";

    Запрос.УстановитьПараметр("Номенклатура", Объект.Номенклатура);
    Запрос.УстановитьПараметр("Показатель", Показатель);

    Результат = Запрос.Выполнить();

    Возврат НЕ Результат.Пустой();

КонецФункции
```

**Использование**: При добавлении показателя вручную проверяется его наличие в нормативной аттестации

---

## 4. Commands/ПромежуточныйКомпозит/CommandModule.bsl (15 строк)

### 4.1 ОбработкаКоманды() - Открытие АРМ

**Полный код**:
```bsl
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)

    // Формирование параметров для открытия формы
    ПараметрыФормы = Новый Структура;
    ПараметрыФормы.Вставить("ПромежуточныйКомпозит", Истина);

    // Открытие основной формы АРМ в режиме "Промежуточный композит"
    ОткрытьФорму(
        "Обработка.гкс_АРМПромежуточныйКомпозит.Форма.Форма",
        ПараметрыФормы,
        ПараметрыВыполненияКоманды.Источник,
        ПараметрыВыполненияКоманды.Уникальность,
        ПараметрыВыполненияКоманды.Окно,
        ПараметрыВыполненияКоманды.НавигационнаяСсылка);

КонецПроцедуры
```

**Логика**:
- Создание параметра `ПромежуточныйКомпозит = Истина`
- Открытие основной формы обработки с этим параметром
- Форма автоматически переключается на страницу "Промежуточные пробы"

---

## 5. Ключевые паттерны и практики

### 5.1 Работа с временными таблицами

**Преимущества**:
- Разбиение сложных запросов на логические блоки
- Переиспользование промежуточных результатов
- Улучшение производительности

**Пример использования**:
```sql
-- Шаг 1: Отбор базовых регистраций
ВЫБРАТЬ ... ПОМЕСТИТЬ ВТ_Регистрации ...

-- Шаг 2: Получение композитных проб
ВЫБРАТЬ ... ПОМЕСТИТЬ ВТ_КомпозитныеПробы
ИЗ РС.гкс_КомпозитныеПробы
ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Регистрации ...

-- Шаг 3: Финальный запрос
ВЫБРАТЬ ...
ИЗ ВТ_Регистрации
ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КомпозитныеПробы ...
```

### 5.2 Клиент-серверное разделение

**Правило**:
- Клиент: UI логика, валидация, навигация
- Сервер: Работа с БД, бизнес-логика, запросы

**Примеры**:
```bsl
// КЛИЕНТ
&НаКлиенте
Процедура КомандаСформироватьПробы(Команда)
    // Валидация UI
    Если НЕ ПроверитьНаличиеВыделенныхСтрок() Тогда
        Возврат;
    КонецЕсли;

    // Вызов сервера для работы с БД
    СформироватьПробыНаСервере();
КонецПроцедуры

// СЕРВЕР
&НаСервере
Процедура СформироватьПробыНаСервере()
    Запрос = Новый Запрос;
    // Работа с базой данных
КонецПроцедуры
```

### 5.3 Параметризация запросов

**Всегда использовать параметры** для защиты от SQL-инъекций:
```bsl
Запрос.Текст = "ВЫБРАТЬ ... ГДЕ Номенклатура = &Номенклатура";
Запрос.УстановитьПараметр("Номенклатура", ЗначениеНоменклатуры);
```

### 5.4 Валидация данных

**Многоуровневая проверка**:
1. Клиентская (UI) - для быстрого отклика
2. Серверная - для целостности данных
3. Бизнес-логика - для соответствия правилам

**Пример**:
```bsl
// Уровень 1: UI валидация
Если НЕ ЗначениеЗаполнено(Показатель) Тогда
    Возврат; // Быстрый выход
КонецЕсли;

// Уровень 2: Серверная проверка
Если НЕ ПроверитьНаличиеПоказателяВНорме(Показатель) Тогда
    ВызватьИсключение "Показатель не найден в нормативе";
КонецЕсли;

// Уровень 3: Бизнес-правила
Если СостояниеКачества <> "ОтборПроб" Тогда
    ВызватьИсключение "Анализы уже выполнены";
КонецЕсли;
```

---

**Конец отчета "02_MODULES_DETAILED_ANALYSIS.md"**

Для анализа SQL запросов и их оптимизации см. отчет:
- `03_SQL_QUERIES_ANALYSIS.md`
