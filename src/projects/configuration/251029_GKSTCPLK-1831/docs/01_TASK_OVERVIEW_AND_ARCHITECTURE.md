# Анализ задачи 251029_GKSTCPLK-1831: Разработка АРМ по промежуточному композиту

**Дата анализа**: 2025-10-29
**Аналитик**: Claude Code
**Статус**: Детальный технический анализ выполнен

---

## 1. Обзор задачи

### 1.1 Цель задачи
Разработать АРМ (автоматизированное рабочее место) для работы с **промежуточными композитными пробами** в рамках системы усиленного контроля качества по партиям транспортных средств.

### 1.2 Ключевые требования

1. **Отображение данных регистраций**:
   - Вывод состояния регистрации (срез последних из РС_СостоянияРегистрации)
   - Подбор данных из РС "Показатели качества усиленного контроля" с назначением использования = "промежуточный композит"
   - Использование РС гкс_СоставГруппТранспорта для получения информации по группам ТС

2. **Фильтрация данных**:
   - По умолчанию: выводить регистрации где состояние качества = Пустое или "Отбор проб"
   - С галкой "показывать все": выводить все регистрации независимо от состояния

3. **Интерактивная работа с таблицей**:
   - При выделении строки автоматически выделять все строки с одинаковыми:
     - Группой ТС
     - Показателем
   - При снятии выделения - снимать по тому же признаку

4. **Валидация перед формированием проб**:
   - Если состояние качества УК по регистрации ≠ пустое и ≠ "Отбор проб":
     - Показать сообщение, что анализы уже сделаны
     - Не открывать форму формирования

5. **Формирование композитных проб**:
   - Передача выбранных показателей на форму формирования номера пробы
   - Дальнейшая передача в лабораторный анализ

6. **Обработка отклоненного качества**:
   - Если качество не принято по регистрации:
     - НЕ включать в композитную пробу
     - Записать в РС гкс_ПоказателиКачестваУсиленногоКонтроля статус "НеПринятоВходнойКонтроль"

7. **Логика лабораторного анализа**:
   - Если тип документа = "Формирование номера проб"
   - Поиск анализов/значений для определения качества по регистрациям, входящим в формирование номера пробы

---

## 2. Архитектура решения

### 2.1 Основные объекты конфигурации

#### 2.1.1 Обработка гкс_АРМПромежуточныйКомпозит

**Назначение**: Главная точка входа для работы с промежуточными композитными пробами

**Структура**:
```
DataProcessors/гкс_АРМПромежуточныйКомпозит/
├── ObjectModule.bsl (312 строк)
│   └── Серверные функции получения данных
├── Forms/
│   ├── Форма/ (601 строка)
│   │   └── Основная форма с двумя страницами
│   └── ФормаФормированиеКомпозитнойФормы/ (363 строки)
│       └── Форма формирования композитной пробы
└── Commands/
    └── ПромежуточныйКомпозит/ (15 строк)
        └── Команда открытия АРМ
```

#### 2.1.2 Регистры сведений

| Регистр | Назначение | Ключевые реквизиты |
|---------|------------|-------------------|
| **гкс_СостоянияРегистрации** | Хранение состояний регистраций | Регистрация, Состояние, Дата |
| **гкс_ПоказателиКачестваУсиленногоКонтроля** | Показатели качества УК | Регистрация, Показатель, СостояниеКачества, НазначениеИспользования |
| **гкс_КомпозитныеПробы** | Композитные пробы | ДокументПроба, ТипПробы, Регистрации |
| **гкс_СоставГруппТранспорта** | Состав групп ТС | Регистрация, ГруппаТС, ПЛК |

#### 2.1.3 Документы

| Документ | Назначение | Связь с задачей |
|----------|------------|-----------------|
| **гкс_РегистрацияНаПЛК** | Регистрация партий на ПЛК | Источник данных для АРМ |
| **гкс_ФормированиеНомераПробы** | Формирование номера пробы | Создается для композитных проб |
| **гкс_ЛабораторныйАнализ** | Лабораторный анализ | Финальный документ с результатами |

### 2.2 Потоки данных

```
┌─────────────────────────────────────────────────────────────────┐
│                  ВХОДНЫЕ ДАННЫЕ                                  │
├─────────────────────────────────────────────────────────────────┤
│ 1. Регистрации на ПЛК (гкс_РегистрацияНаПЛК)                   │
│ 2. Показатели качества УК (РС)                                  │
│ 3. Состояния регистраций (РС)                                   │
│ 4. Состав групп ТС (РС)                                         │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│          АРМ ПРОМЕЖУТОЧНЫЙ КОМПОЗИТ (Обработка)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────┐         │
│  │  Страница 1: Произвольный композит                │         │
│  │  - Список регистраций с фильтрами                 │         │
│  │  - Выбор строк по группам ТС + показателям        │         │
│  └───────────────────────────────────────────────────┘         │
│                                                                  │
│  ┌───────────────────────────────────────────────────┐         │
│  │  Страница 2: Промежуточные пробы                  │         │
│  │  - Список существующих промежуточных проб         │         │
│  │  - Навигация по производственным суткам           │         │
│  └───────────────────────────────────────────────────┘         │
│                                                                  │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│        ФОРМА ФОРМИРОВАНИЯ КОМПОЗИТНОЙ ПРОБЫ                     │
├─────────────────────────────────────────────────────────────────┤
│ 1. Загрузка показателей из нормативной аттестации               │
│ 2. Добавление/удаление показателей                              │
│ 3. Валидация показателей                                        │
└────────────────────┬────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────────┐
│              СОЗДАНИЕ ДОКУМЕНТОВ                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. гкс_ФормированиеНомераПробы (промежуточный композит)        │
│    - НазначениеИспользованияКачества = ПромежуточныйКомпозит   │
│    - ТипПробы = Композитная                                     │
│    - Заполнение регистраций                                     │
│                                                                  │
│ 2. гкс_ЛабораторныйАнализ (автоматически)                      │
│    - Связь с формированием номера пробы                         │
│    - Показатели качества для анализа                            │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 Бизнес-логика

#### 2.3.1 Алгоритм выборки регистраций

```sql
-- Шаг 1: Получение базовых регистраций с фильтрами
ВЫБРАТЬ
    Регистрации.*,
    СрезПоследнихСостоянияРегистрации.СостояниеРегистрации,
    ПоказателиКачестваУК.Показатель,
    СоставГруппТС.ГруппаТС
ИЗ
    Документ.гкс_РегистрацияНаПЛК КАК Регистрации

    ЛЕВОЕ СОЕДИНЕНИЕ РС.гкс_СостоянияРегистрации.СрезПоследних КАК СостоянияРег
        ПО Регистрации.Ссылка = СостоянияРег.Регистрация

    ЛЕВОЕ СОЕДИНЕНИЕ РС.гкс_ПоказателиКачестваУсиленногоКонтроля КАК ПоказателиКачестваУК
        ПО Регистрации.Ссылка = ПоказателиКачестваУК.Регистрация
        И ПоказателиКачестваУК.НазначениеИспользования = "ПромежуточныйКомпозит"

    ЛЕВОЕ СОЕДИНЕНИЕ РС.гкс_СоставГруппТранспорта КАК СоставГруппТС
        ПО Регистрации.Ссылка = СоставГруппТС.Регистрация
ГДЕ
    -- Фильтрация по состоянию качества
    (ПоказателиКачестваУК.СостояниеКачества В (ЗНАЧЕНИЕ(Перечисление.СостоянияКачества.ПустаяСсылка),
                                                 ЗНАЧЕНИЕ(Перечисление.СостоянияКачества.ОтборПроб))
    ИЛИ &ПоказыватьВсе = ИСТИНА)

    -- Дополнительные фильтры по отборам АРМ
    И Регистрации.Организация В (&ОтборОрганизация)
    И Регистрации.ПЛК В (&ОтборПЛК)
    И Регистрации.ДатаРегистрации МЕЖДУ &ДатаНач И &ДатаКон
```

#### 2.3.2 Логика интерактивного выделения строк

```bsl
// При выделении строки
Процедура ПриВыделенииСтроки(ВыделеннаяСтрока)
    ТекущаяГруппаТС = ВыделеннаяСтрока.ГруппаТС;
    ТекущийПоказатель = ВыделеннаяСтрока.Показатель;

    // Выделить все строки с той же группой ТС и показателем
    Для Каждого Строка Из Объект.ТаблицаДанных Цикл
        Если Строка.ГруппаТС = ТекущаяГруппаТС
            И Строка.Показатель = ТекущийПоказатель Тогда
            Строка.Отметка = Истина;
        КонецЕсли;
    КонецЦикла;
КонецПроцедуры
```

#### 2.3.3 Валидация перед формированием

```bsl
Функция ПроверитьВозможностьФормирования(ВыбранныеСтроки)
    Для Каждого Строка Из ВыбранныеСтроки Цикл
        Если ЗначениеЗаполнено(Строка.СостояниеКачестваУК)
            И Строка.СостояниеКачестваУК <> Перечисления.СостоянияКачества.ОтборПроб Тогда

            ТекстСообщения = "Анализы уже выполнены для выбранных регистраций. "
                           + "Повторное формирование композитной пробы невозможно.";
            ПоказатьПредупреждение(, ТекстСообщения);
            Возврат Ложь;
        КонецЕсли;
    КонецЦикла;

    Возврат Истина;
КонецФункции
```

#### 2.3.4 Обработка отклоненного качества

```bsl
Процедура ОбработатьРегистрацииПриФормированииПробы(МассивРегистраций)
    Для Каждого Регистрация Из МассивРегистраций Цикл
        // Проверка качества по входному контролю
        Если ПолучитьСтатусКачества(Регистрация) = "НеПринято" Тогда
            // НЕ включаем в композитную пробу
            // Записываем статус в регистр
            НаборЗаписей = РегистрыСведений.гкс_ПоказателиКачестваУсиленногоКонтроля.СоздатьНаборЗаписей();
            НаборЗаписей.Отбор.Регистрация.Установить(Регистрация);

            НоваяЗапись = НаборЗаписей.Добавить();
            НоваяЗапись.Регистрация = Регистрация;
            НоваяЗапись.СостояниеКачества = Перечисления.СостоянияКачестваУК.НеПринятоВходнойКонтроль;

            НаборЗаписей.Записать();

            // Исключаем из дальнейшей обработки
            Продолжить;
        КонецЕсли;

        // Обычная обработка для принятых регистраций
        ВключитьВКомпозитнуюПробу(Регистрация);
    КонецЦикла;
КонецПроцедуры
```

---

## 3. Ключевые модули и их функции

### 3.1 ObjectModule.bsl (312 строк)

**Экспортные функции**:

| Функция | Назначение | Параметры |
|---------|------------|-----------|
| `ДанныеДляСписокПроизвольныйКомпозит()` | Получение данных для произвольного композита | Структура с отборами |
| `ДанныеДляСписокПромежуточныеПробы()` | Получение списка промежуточных проб | Структура с отборами |
| `ДанныеДляСписокРегистрацииПромежуточныхПроб()` | Получение регистраций для промежуточных проб | Структура с отборами |

**Особенности**:
- Использование временных таблиц (ПОМЕСТИТЬ) для оптимизации
- Сложные запросы с множественными соединениями
- Фильтрация по состоянию качества УК

### 3.2 Forms/Форма/Module.bsl (601 строка)

**Ключевые процедуры**:

| Процедура | Назначение |
|-----------|------------|
| `ПриОткрытии()` | Инициализация формы, загрузка данных |
| `ОбновитьДанные()` | Обновление таблицы данных |
| `ТаблицаПроизвольныйКомпозитПриИзмененииФлажка()` | Обработка выделения строк |
| `КомандаСформироватьПробыПроизвольныйКомпозит()` | Формирование композитных проб |
| `ПроверитьСовпадениеДанныхСПервойСтрокой()` | Валидация выбранных строк |

**Интерфейс**:
- Двухстраничная форма (Произвольный композит / Промежуточные пробы)
- Навигация по производственным суткам (кнопки +/- день)
- Печать этикеток для проб
- Открытие существующих документов формирования

### 3.3 Forms/ФормаФормированиеКомпозитнойФормы/Module.bsl (363 строки)

**Ключевые процедуры**:

| Процедура | Назначение |
|-----------|------------|
| `ЗагрузитьПоказателиИзНормативнойАттестации()` | Загрузка показателей из норматива |
| `ДобавитьПоказатель()` | Добавление показателя в таблицу |
| `СформироватьДокумент()` | Создание документа формирования номера пробы |
| `ПроверитьНаличиеПоказателяВНорме()` | Валидация показателя |

**Логика**:
- Работа с нормативной аттестацией номенклатуры
- Валидация показателей перед добавлением
- Создание документа гкс_ФормированиеНомераПробы с типом "ПромежуточныйКомпозит"
- Автоматическое создание лабораторного анализа

---

## 4. Интеграционные точки

### 4.1 Связь с регистрами сведений

```
АРМ Промежуточный Композит
    │
    ├─► РС.гкс_СостоянияРегистрации (чтение)
    │   └─ Получение текущего состояния регистрации
    │
    ├─► РС.гкс_ПоказателиКачестваУсиленногоКонтроля (чтение/запись)
    │   ├─ Чтение: получение показателей с назначением "ПромежуточныйКомпозит"
    │   └─ Запись: установка статуса "НеПринятоВходнойКонтроль"
    │
    ├─► РС.гкс_СоставГруппТранспорта (чтение)
    │   └─ Получение информации о группе ТС для регистрации
    │
    └─► РС.гкс_КомпозитныеПробы (чтение)
        └─ Проверка существующих композитных проб
```

### 4.2 Связь с документами

```
АРМ Промежуточный Композит
    │
    ├─► Документ.гкс_РегистрацияНаПЛК (чтение)
    │   └─ Источник данных для формирования проб
    │
    ├─► Документ.гкс_ФормированиеНомераПробы (создание/открытие)
    │   ├─ Создание нового документа с типом "ПромежуточныйКомпозит"
    │   └─ Открытие существующего для просмотра/редактирования
    │
    └─► Документ.гкс_ЛабораторныйАнализ (косвенная связь)
        └─ Автоматически создается при формировании номера пробы
```

---

## 5. Бизнес-процесс

### 5.1 Полный цикл работы

```
1. Открытие АРМ
   ↓
2. Выбор страницы "Произвольный композит"
   ↓
3. Установка отборов (организация, ПЛК, даты)
   ↓
4. Загрузка данных регистраций
   ├─ Фильтрация по состоянию качества УК
   ├─ Группировка по группам ТС
   └─ Отображение показателей качества
   ↓
5. Выделение строк (автоматическая группировка)
   ├─ Выделение по Группе ТС + Показатель
   └─ Валидация совпадения номенклатуры/контрагента
   ↓
6. Проверка возможности формирования
   ├─ Проверка состояния качества
   └─ Проверка наличия существующих анализов
   ↓
7. Открытие формы формирования композитной пробы
   ├─ Если есть документ → открыть гкс_ФормированиеНомераПробы
   └─ Если нет → открыть ФормаФормированиеКомпозитнойФормы
   ↓
8. Формирование номера пробы
   ├─ Загрузка показателей из норматива
   ├─ Добавление дополнительных показателей
   └─ Валидация показателей
   ↓
9. Создание документов
   ├─ гкс_ФормированиеНомераПробы (ТипПробы = Композитная)
   └─ гкс_ЛабораторныйАнализ (автоматически)
   ↓
10. Проведение документов
    ├─ Обновление РС.гкс_КомпозитныеПробы
    ├─ Обновление РС.гкс_ПоказателиКачестваУсиленногоКонтроля
    └─ Создание движений по регистрам
```

### 5.2 Обработка исключений

| Ситуация | Действие |
|----------|----------|
| Состояние качества ≠ пустое/отбор проб | Показать предупреждение, не открывать форму |
| Качество не принято по входному контролю | Не включать в пробу, записать статус "НеПринятоВходнойКонтроль" |
| Несовпадение номенклатуры в выбранных строках | Предупреждение с запросом подтверждения |
| Несовпадение контрагента | Предупреждение с запросом подтверждения |
| Показатель не найден в нормативе | Предупреждение, запрет добавления |

---

## 6. Технические особенности

### 6.1 Оптимизация производительности

- **Временные таблицы**: Использование ПОМЕСТИТЬ для разбиения сложных запросов
- **Индексация**: По ключевым полям регистров (Регистрация, Показатель, ГруппаТС)
- **Кэширование**: Список показателей нормативной аттестации
- **Пакетная обработка**: Массовое выделение строк по группам

### 6.2 Пользовательский интерфейс

- **Двухстраничная форма**: Разделение произвольного и промежуточного композита
- **Автоматическое выделение**: Интеллектуальное группирование строк
- **Навигация по датам**: Кнопки для перехода по производственным суткам
- **Визуальные индикаторы**: Цветовая маркировка состояний

### 6.3 Безопасность данных

- **Транзакции**: При создании документов и записи в регистры
- **Валидация**: Многоуровневая проверка данных перед формированием
- **Блокировки**: Предотвращение дублирования проб
- **Аудит**: Фиксация изменений состояний качества

---

## 7. Выводы и рекомендации

### 7.1 Соответствие требованиям

✅ **Реализовано**:
- Отображение состояний регистраций
- Фильтрация по назначению использования "ПромежуточныйКомпозит"
- Интерактивное выделение по группам ТС + показателям
- Валидация перед формированием
- Обработка отклоненного качества
- Создание документов формирования и лабораторных анализов

### 7.2 Потенциальные улучшения

1. **Производительность**:
   - Добавить индексы на РС.гкс_ПоказателиКачестваУсиленногоКонтроля
   - Кэшировать результаты запросов состояний регистраций

2. **Пользовательский интерфейс**:
   - Добавить визуализацию состава композитной пробы (граф связей)
   - Реализовать быстрые фильтры по группам ТС

3. **Функциональность**:
   - Добавить массовую печать этикеток
   - Реализовать историю изменений состояний качества
   - Добавить предпросмотр результатов перед формированием

4. **Документирование**:
   - Создать руководство пользователя
   - Добавить встроенную справку в форму
   - Документировать бизнес-правила валидации

---

**Конец отчета "01_TASK_OVERVIEW_AND_ARCHITECTURE.md"**

Для детального анализа модулей и SQL запросов см. соответствующие отчеты:
- `02_MODULES_DETAILED_ANALYSIS.md`
- `03_SQL_QUERIES_ANALYSIS.md`
