# План реализации задачи 251029_GKSTCPLK-1831 (Часть 2)

**Продолжение файла**: 04_IMPLEMENTATION_PLAN.md

---

## Этап 5: Интеграция с документами

**Длительность**: 2 дня (16 часов)
**Ответственный**: Разработчик 1С

### 5.1 Модификация документа гкс_ФормированиеНомераПробы

**Время**: 6 часов

#### 5.1.1 Создать метод ДокументПромежуточногоКомпозита()

**Код** (добавить в модуль менеджера документа):
```bsl
// Создает документ формирования номера пробы для промежуточного композита
//
// Параметры:
//   ПараметрыСоздания - Структура - параметры создания документа:
//     * Организация - СправочникСсылка.Организации
//     * ПЛК - СправочникСсылка.ПЛК
//     * Номенклатура - СправочникСсылка.Номенклатура
//     * Контрагент - СправочникСсылка.Контрагенты
//     * МассивРегистраций - Массив из ДокументСсылка.гкс_РегистрацияНаПЛК
//     * ТипПробы - ПеречислениеСсылка.гкс_ТипыПроб
//   ПараметрыСозданияАнализа - Структура - параметры для лабораторного анализа:
//     * МассивПоказателей - Массив из СправочникСсылка.Показатели
//     * НазначениеИспользованияКачества - ПеречислениеСсылка.гкс_НазначенияИспользованияКачества
//
// Возвращаемое значение:
//   ДокументСсылка.гкс_ФормированиеНомераПробы - созданный документ
//
Функция ДокументПромежуточногоКомпозита(ПараметрыСоздания, ПараметрыСозданияАнализа) Экспорт

	// Начало транзакции
	НачатьТранзакцию();

	Попытка

		// Создание нового документа
		НовыйДокумент = Документы.гкс_ФормированиеНомераПробы.СоздатьДокумент();

		// Заполнение шапки
		НовыйДокумент.Дата = ТекущаяДата();
		НовыйДокумент.Организация = ПараметрыСоздания.Организация;
		НовыйДокумент.ПЛК = ПараметрыСоздания.ПЛК;
		НовыйДокумент.Номенклатура = ПараметрыСоздания.Номенклатура;
		НовыйДокумент.Контрагент = ПараметрыСоздания.Контрагент;
		НовыйДокумент.ТипПробы = ПараметрыСоздания.ТипПробы;
		НовыйДокумент.НазначениеИспользованияКачества =
			ПараметрыСозданияАнализа.НазначениеИспользованияКачества;

		// Определение производственных суток (из первой регистрации)
		Если ПараметрыСоздания.МассивРегистраций.Количество() > 0 Тогда
			ПерваяРегистрация = ПараметрыСоздания.МассивРегистраций[0];
			НовыйДокумент.ПроизводственныеСутки =
				ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПерваяРегистрация, "ПроизводственныеСутки");
		КонецЕсли;

		// Заполнение табличной части Регистрации
		Для Каждого Регистрация Из ПараметрыСоздания.МассивРегистраций Цикл
			НоваяСтрока = НовыйДокумент.Регистрации.Добавить();
			НоваяСтрока.Регистрация = Регистрация;
		КонецЦикла;

		// Заполнение табличной части Показатели
		Для Каждого Показатель Из ПараметрыСозданияАнализа.МассивПоказателей Цикл
			НоваяСтрока = НовыйДокумент.Показатели.Добавить();
			НоваяСтрока.Показатель = Показатель;
		КонецЦикла;

		// Генерация номера пробы
		НовыйДокумент.НомерПробы = СгенерироватьНомерПробы(
			НовыйДокумент.ПЛК,
			НовыйДокумент.ПроизводственныеСутки);

		// Запись документа
		НовыйДокумент.Записать();

		// Проведение документа
		НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);

		// Создание лабораторного анализа
		ДокументАнализ = СоздатьЛабораторныйАнализДляПромежуточногоКомпозита(
			НовыйДокумент.Ссылка,
			ПараметрыСозданияАнализа);

		// Обновление ссылки на лабораторный анализ
		Если ЗначениеЗаполнено(ДокументАнализ) Тогда
			ДокументОбъект = НовыйДокумент.Ссылка.ПолучитьОбъект();
			ДокументОбъект.ЛабораторныйАнализ = ДокументАнализ;
			ДокументОбъект.Записать();
		КонецЕсли;

		// Фиксация транзакции
		ЗафиксироватьТранзакцию();

		// Сообщение о результате
		ТекстСообщения = СтрШаблон(
			НСтр("ru = 'Создан документ формирования номера пробы %1 от %2'"),
			НовыйДокумент.Номер,
			Формат(НовыйДокумент.Дата, "ДЛФ=D"));
		Сообщить(ТекстСообщения);

		Возврат НовыйДокумент.Ссылка;

	Исключение

		// Откат транзакции
		ОтменитьТранзакцию();

		// Логирование ошибки
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		ЗаписьЖурналаРегистрации(
			"АРМ.ПромежуточныйКомпозит.СозданиеДокумента",
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			ТекстОшибки);

		// Повторное возбуждение исключения
		ВызватьИсключение;

	КонецПопытки;

КонецФункции

Функция СгенерироватьНомерПробы(ПЛК, ПроизводственныеСутки)

	// Логика генерации номера пробы
	// Пример: ПЛК-ГГММДД-NNNN

	КодПЛК = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПЛК, "Код");
	Если НЕ ЗначениеЗаполнено(КодПЛК) Тогда
		КодПЛК = "ПЛК";
	КонецЕсли;

	ДатаСтрока = Формат(ПроизводственныеСутки, "ДФ=ггММдд");

	// Получение последнего номера за эти сутки
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	МАКСИМУМ(ФормированиеНомераПробы.НомерПробы) КАК ПоследнийНомер
	|ИЗ
	|	Документ.гкс_ФормированиеНомераПробы КАК ФормированиеНомераПробы
	|ГДЕ
	|	ФормированиеНомераПробы.ПЛК = &ПЛК
	|	И ФормированиеНомераПробы.ПроизводственныеСутки = &ПроизводственныеСутки
	|	И ФормированиеНомераПробы.НазначениеИспользованияКачества =
	|		ЗНАЧЕНИЕ(Перечисление.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит)";

	Запрос.УстановитьПараметр("ПЛК", ПЛК);
	Запрос.УстановитьПараметр("ПроизводственныеСутки", ПроизводственныеСутки);

	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();

	ПорядковыйНомер = 1;
	Если Выборка.Следующий() И ЗначениеЗаполнено(Выборка.ПоследнийНомер) Тогда
		// Извлечение порядкового номера из последнего номера пробы
		// Формат: ПЛК-ГГММДД-NNNN
		ЧастиНомера = СтрРазделить(Выборка.ПоследнийНомер, "-");
		Если ЧастиНомера.Количество() = 3 Тогда
			ПопыткаПреобразовать = Число(ЧастиНомера[2]);
			Если ПопыткаПреобразовать <> Неопределено Тогда
				ПорядковыйНомер = ПопыткаПреобразовать + 1;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	НомерПробы = СтрШаблон("%1-%2-%3",
		КодПЛК,
		ДатаСтрока,
		Формат(ПорядковыйНомер, "ЧЦ=4; ЧВН=; ЧГ=0"));

	Возврат НомерПробы;

КонецФункции

Функция СоздатьЛабораторныйАнализДляПромежуточногоКомпозита(ДокументПроба, ПараметрыСозданияАнализа)

	// Создание документа лабораторного анализа
	НовыйАнализ = Документы.гкс_ЛабораторныйАнализ.СоздатьДокумент();

	// Заполнение шапки из документа пробы
	РеквизитыПробы = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
		ДокументПроба,
		"Организация, ПЛК, Номенклатура, Контрагент, ПроизводственныеСутки");

	НовыйАнализ.Дата = ТекущаяДата();
	НовыйАнализ.Организация = РеквизитыПробы.Организация;
	НовыйАнализ.ПЛК = РеквизитыПробы.ПЛК;
	НовыйАнализ.Номенклатура = РеквизитыПробы.Номенклатура;
	НовыйАнализ.Контрагент = РеквизитыПробы.Контрагент;
	НовыйАнализ.ПроизводственныеСутки = РеквизитыПробы.ПроизводственныеСутки;
	НовыйАнализ.ДокументОснование = ДокументПроба;
	НовыйАнализ.НазначениеИспользованияКачества =
		ПараметрыСозданияАнализа.НазначениеИспользованияКачества;

	// Заполнение показателей
	Для Каждого Показатель Из ПараметрыСозданияАнализа.МассивПоказателей Цикл
		НоваяСтрока = НовыйАнализ.Показатели.Добавить();
		НоваяСтрока.Показатель = Показатель;
		// Другие реквизиты по необходимости
	КонецЦикла;

	// Запись документа
	НовыйАнализ.Записать();

	ТекстСообщения = СтрШаблон(
		НСтр("ru = 'Создан документ лабораторного анализа %1 от %2'"),
		НовыйАнализ.Номер,
		Формат(НовыйАнализ.Дата, "ДЛФ=D"));
	Сообщить(ТекстСообщения);

	Возврат НовыйАнализ.Ссылка;

КонецФункции
```

#### Чеклист 5.1.1:
- [ ] Метод ДокументПромежуточногоКомпозита() создан
- [ ] Создание документа работает
- [ ] Заполнение регистраций работает
- [ ] Генерация номера пробы работает
- [ ] Создание лабораторного анализа работает
- [ ] Транзакции работают корректно
- [ ] Обработка ошибок реализована

### 5.2 Проведение документа гкс_ФормированиеНомераПробы

**Время**: 4 часа

#### 5.2.1 Обработчик ОбработкаПроведения()

**Код** (добавить в модуль объекта документа):
```bsl
Процедура ОбработкаПроведения(Отказ, РежимПроведения)

	// Проверка заполнения обязательных реквизитов
	Если НЕ ПроверитьЗаполнениеОбязательныхРеквизитов(Отказ) Тогда
		Возврат;
	КонецЕсли;

	// Запись в регистр гкс_КомпозитныеПробы
	ЗаписатьРегистрКомпозитныеПробы(Отказ);

	// Обновление состояния качества по регистрациям (если нужно)
	ОбновитьСостоянияКачестваРегистраций(Отказ);

	// Обработка отклоненных регистраций
	ОбработатьОтклоненныеРегистрации(Отказ);

КонецПроцедуры

Функция ПроверитьЗаполнениеОбязательныхРеквизитов(Отказ)

	Результат = Истина;

	Если НЕ ЗначениеЗаполнено(Организация) Тогда
		ТекстСообщения = НСтр("ru = 'Не заполнено поле ""Организация""'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, "Организация", , Отказ);
		Результат = Ложь;
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(ПЛК) Тогда
		ТекстСообщения = НСтр("ru = 'Не заполнено поле ""ПЛК""'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, "ПЛК", , Отказ);
		Результат = Ложь;
	КонецЕсли;

	Если Регистрации.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Не заполнена табличная часть ""Регистрации""'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, , , Отказ);
		Результат = Ложь;
	КонецЕсли;

	Если Показатели.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Не заполнена табличная часть ""Показатели""'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, , , Отказ);
		Результат = Ложь;
	КонецЕсли;

	Возврат Результат;

КонецФункции

Процедура ЗаписатьРегистрКомпозитныеПробы(Отказ)

	// Очистка старых записей
	НаборЗаписей = РегистрыСведений.гкс_КомпозитныеПробы.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.ДокументПроба.Установить(Ссылка);
	НаборЗаписей.Очистить();

	// Создание новых записей
	Для Каждого СтрокаРегистрация Из Регистрации Цикл
		Для Каждого СтрокаПоказатель Из Показатели Цикл

			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.ДокументПроба = Ссылка;
			НоваяЗапись.Регистрация = СтрокаРегистрация.Регистрация;
			НоваяЗапись.ТипПробы = ТипПробы;
			НоваяЗапись.Показатель = СтрокаПоказатель.Показатель;

		КонецЦикла;
	КонецЦикла;

	// Запись набора
	Попытка
		НаборЗаписей.Записать();
	Исключение
		ТекстСообщения = СтрШаблон(
			НСтр("ru = 'Ошибка записи регистра гкс_КомпозитныеПробы: %1'"),
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, , , Отказ);
	КонецПопытки;

КонецПроцедуры

Процедура ОбновитьСостоянияКачестваРегистраций(Отказ)

	// Если назначение использования = ПромежуточныйКомпозит
	Если НазначениеИспользованияКачества <>
		Перечисления.гкс_НазначенияИспользованияКачества.ПромежуточныйКомпозит Тогда
		Возврат;
	КонецЕсли;

	// Обновление состояния качества для каждой регистрации
	Для Каждого СтрокаРегистрация Из Регистрации Цикл

		НаборЗаписей = РегистрыСведений.гкс_ПоказателиКачестваУсиленногоКонтроля.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистрация.Установить(СтрокаРегистрация.Регистрация);

		Для Каждого СтрокаПоказатель Из Показатели Цикл

			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.Регистрация = СтрокаРегистрация.Регистрация;
			НоваяЗапись.Показатель = СтрокаПоказатель.Показатель;
			НоваяЗапись.НазначениеИспользования = НазначениеИспользованияКачества;
			НоваяЗапись.СостояниеКачества =
				Перечисления.гкс_СостоянияКачестваУсиленногоКонтроля.ОтборПроб;

		КонецЦикла;

		Попытка
			НаборЗаписей.Записать();
		Исключение
			ТекстСообщения = СтрШаблон(
				НСтр("ru = 'Ошибка обновления состояния качества для регистрации %1: %2'"),
				СтрокаРегистрация.Регистрация,
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, ЭтотОбъект, , , Отказ);
		КонецПопытки;

	КонецЦикла;

КонецПроцедуры

Процедура ОбработатьОтклоненныеРегистрации(Отказ)

	// Получить регистрации с отклоненным качеством
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Регистрации.Регистрация КАК Регистрация,
	|	СостоянияРегистрации.СостояниеРегистрации
	|ИЗ
	|	Документ.гкс_ФормированиеНомераПробы.Регистрации КАК Регистрации
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.гкс_СостоянияРегистрации.СрезПоследних(
	|			&Дата,
	|			Регистрация В (&МассивРегистраций)) КАК СостоянияРегистрации
	|			ПО Регистрации.Регистрация = СостоянияРегистрации.Регистрация
	|ГДЕ
	|	Регистрации.Ссылка = &Ссылка
	|	И СостоянияРегистрации.СостояниеРегистрации =
	|		ЗНАЧЕНИЕ(Перечисление.СостоянияРегистрации.НеПринято)";

	МассивРегистраций = Новый Массив;
	Для Каждого Строка Из Регистрации Цикл
		МассивРегистраций.Добавить(Строка.Регистрация);
	КонецЦикла;

	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("МассивРегистраций", МассивРегистраций);

	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();

	// Для отклоненных регистраций записать состояние "НеПринятоВходнойКонтроль"
	Пока Выборка.Следующий() Цикл

		НаборЗаписей = РегистрыСведений.гкс_ПоказателиКачестваУсиленногоКонтроля.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистрация.Установить(Выборка.Регистрация);

		Для Каждого СтрокаПоказатель Из Показатели Цикл

			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.Регистрация = Выборка.Регистрация;
			НоваяЗапись.Показатель = СтрокаПоказатель.Показатель;
			НоваяЗапись.НазначениеИспользования = НазначениеИспользованияКачества;
			НоваяЗапись.СостояниеКачества =
				Перечисления.гкс_СостоянияКачестваУсиленногоКонтроля.НеПринятоВходнойКонтроль;

		КонецЦикла;

		Попытка
			НаборЗаписей.Записать();
		Исключение
			// Логирование ошибки
		КонецПопытки;

	КонецЦикла;

КонецПроцедуры
```

#### Чеклист 5.2:
- [ ] Обработчик ОбработкаПроведения() создан
- [ ] Валидация обязательных реквизитов работает
- [ ] Запись в гкс_КомпозитныеПробы работает
- [ ] Обновление состояний качества работает
- [ ] Обработка отклоненных регистраций работает
- [ ] Транзакции работают корректно

### 5.3 Интеграция с лабораторным анализом

**Время**: 3 часа

#### 5.3.1 Логика поиска значений для определения качества

**Код** (добавить в модуль документа гкс_ЛабораторныйАнализ):
```bsl
// Для документов типа "Промежуточный композит"
// Поиск анализов/значений по регистрациям, входящим в формирование номера пробы

Функция ПолучитьЗначенияПоказателейДляПромежуточногоКомпозита(ДокументОснование)

	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КомпозитныеПробы.Регистрация,
	|	КомпозитныеПробы.Показатель,
	|	СРЕДНЕЕ(ЗначенияПоказателей.Значение) КАК СреднееЗначение
	|ИЗ
	|	РегистрСведений.гкс_КомпозитныеПробы КАК КомпозитныеПробы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.гкс_ЗначенияПоказателей КАК ЗначенияПоказателей
	|			ПО КомпозитныеПробы.Регистрация = ЗначенияПоказателей.Регистрация
	|			И КомпозитныеПробы.Показатель = ЗначенияПоказателей.Показатель
	|ГДЕ
	|	КомпозитныеПробы.ДокументПроба = &ДокументОснование
	|СГРУППИРОВАТЬ ПО
	|	КомпозитныеПробы.Регистрация,
	|	КомпозитныеПробы.Показатель";

	Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);

	Результат = Запрос.Выполнить();
	Возврат Результат.Выгрузить();

КонецФункции
```

#### Чеклист 5.3:
- [ ] Функция поиска значений создана
- [ ] Логика расчета среднего значения работает
- [ ] Интеграция с лабораторным анализом работает
- [ ] Тестирование выполнено

### 5.4 Обновление основной формы АРМ

**Время**: 3 часа

#### 5.4.1 Команда формирования проб

**Код** (добавить в модуль формы):
```bsl
&НаКлиенте
Процедура КомандаСформироватьПробыПроизвольныйКомпозит(Команда)

	// 1. Проверка наличия выделенных строк
	Если НЕ ПроверитьНаличиеВыделенныхСтрок() Тогда
		Возврат;
	КонецЕсли;

	// 2. Сбор выделенных строк
	МассивВыделенныхСтрок = Новый Массив;
	ПерваяОтмеченнаяСтрока = Неопределено;

	Для Каждого СтрокаТаблицы Из ТаблицаПроизвольныйКомпозит Цикл
		Если СтрокаТаблицы.Отметка = Истина Тогда

			Если ПерваяОтмеченнаяСтрока = Неопределено Тогда
				ПерваяОтмеченнаяСтрока = СтрокаТаблицы;
			Иначе
				// 3. Валидация совпадения данных
				Если НЕ ПроверитьСовпадениеДанныхСПервойСтрокой(
					СтрокаТаблицы, ПерваяОтмеченнаяСтрока) Тогда
					Возврат;
				КонецЕсли;
			КонецЕсли;

			МассивВыделенныхСтрок.Добавить(СтрокаТаблицы);

		КонецЕсли;
	КонецЦикла;

	// 4. Проверка возможности формирования
	ДокументКомпозитнаяПроба = ПерваяОтмеченнаяСтрока.ДокументКомпозитнаяПроба;

	// 5. Валидация состояния качества
	Если ЗначениеЗаполнено(ПерваяОтмеченнаяСтрока.СостояниеКачества)
		И ПерваяОтмеченнаяСтрока.СостояниеКачества <>
			ПредопределенноеЗначение("Перечисление.гкс_СостоянияКачестваУсиленногоКонтроля.ОтборПроб") Тогда

		ТекстСообщения = НСтр("ru = 'Анализы для выбранных регистраций уже выполнены. " +
		                             "Формирование новой композитной пробы невозможно.'");
		ПоказатьПредупреждение(, ТекстСообщения);
		Возврат;
	КонецЕсли;

	// 6. Формирование параметров для открытия формы
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("Организация", ПерваяОтмеченнаяСтрока.Организация);
	ПараметрыФормы.Вставить("ПЛК", ПерваяОтмеченнаяСтрока.ПЛК);
	ПараметрыФормы.Вставить("Номенклатура", ПерваяОтмеченнаяСтрока.Номенклатура);
	ПараметрыФормы.Вставить("Контрагент", ПерваяОтмеченнаяСтрока.Контрагент);

	// Массив регистраций
	МассивРегистраций = Новый Массив;
	Для Каждого СтрокаВыделенная Из МассивВыделенныхСтрок Цикл
		Если МассивРегистраций.Найти(СтрокаВыделенная.Регистрация) = Неопределено Тогда
			МассивРегистраций.Добавить(СтрокаВыделенная.Регистрация);
		КонецЕсли;
	КонецЦикла;
	ПараметрыФормы.Вставить("МассивРегистраций", МассивРегистраций);

	// Массив показателей
	МассивПоказателей = Новый Массив;
	Для Каждого СтрокаВыделенная Из МассивВыделенныхСтрок Цикл
		Если ЗначениеЗаполнено(СтрокаВыделенная.Показатель)
			И МассивПоказателей.Найти(СтрокаВыделенная.Показатель) = Неопределено Тогда
			МассивПоказателей.Добавить(СтрокаВыделенная.Показатель);
		КонецЕсли;
	КонецЦикла;
	ПараметрыФормы.Вставить("МассивПоказателей", МассивПоказателей);

	// 7. Открытие формы
	Если ЗначениеЗаполнено(ДокументКомпозитнаяПроба) Тогда
		// Открыть существующий документ
		ИмяФормыДокумента = "Документ.гкс_ФормированиеНомераПробы.Форма.ФормаДокумента";
		ПараметрыФормы.Вставить("Ключ", ДокументКомпозитнаяПроба);
	Иначе
		// Открыть форму создания нового
		ИмяФормыДокумента = "Обработка.гкс_АРМПромежуточныйКомпозит.Форма.ФормаФормированиеКомпозитнойФормы";
	КонецЕсли;

	// Открытие формы с обработчиком закрытия
	ОповещениеПослеЗакрытия = Новый ОписаниеОповещения(
		"ПослеЗакрытияФормыФормирования",
		ЭтотОбъект);

	ОткрытьФорму(ИмяФормыДокумента, ПараметрыФормы, ЭтаФорма, , , , ОповещениеПослеЗакрытия);

КонецПроцедуры

&НаКлиенте
Процедура ПослеЗакрытияФормыФормирования(РезультатЗакрытия, ДополнительныеПараметры) Экспорт

	// Обновление данных после закрытия формы формирования
	ОбновлениеОтображенияДанных();

	// Снятие отметок
	Для Каждого Строка Из ТаблицаПроизвольныйКомпозит Цикл
		Строка.Отметка = Ложь;
	КонецЦикла;

КонецПроцедуры
```

#### Чеклист 5.4:
- [ ] Команда формирования проб создана
- [ ] Все валидации работают
- [ ] Открытие формы работает
- [ ] Обновление после закрытия работает
- [ ] Тестирование выполнено

---

## Этап 6: Тестирование

**Длительность**: 2 дня (16 часов)
**Ответственные**: Разработчик 1С, Тестировщик

### 6.1 Подготовка тестовых данных

**Время**: 2 часа

#### Задачи:
- [ ] Создать 100 тестовых регистраций на ПЛК
- [ ] Создать 5-10 показателей качества
- [ ] Создать 3-5 групп транспорта
- [ ] Заполнить нормативную аттестацию для тестовой номенклатуры
- [ ] Создать РС.гкс_СоставГруппТранспорта для регистраций
- [ ] Создать РС.гкс_ПоказателиКачестваУсиленногоКонтроля

**Скрипт подготовки данных** (создать обработку или процедуру):
```bsl
Процедура СоздатьТестовыеДанныеДляАРМ()

	// ... код создания тестовых данных ...

КонецПроцедуры
```

### 6.2 Функциональное тестирование

**Время**: 8 часов

#### 6.2.1 Тест-кейсы для основной формы

**TC-01: Открытие АРМ в режиме "Произвольный композит"**
- [ ] Предусловия: Пользователь авторизован
- [ ] Открыть АРМ через навигационную панель
- [ ] **Ожидаемый результат**: Форма открывается на странице "Произвольный композит"
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-02: Открытие АРМ в режиме "Промежуточный композит"**
- [ ] Предусловия: Пользователь авторизован
- [ ] Открыть АРМ через команду "Промежуточный композит"
- [ ] **Ожидаемый результат**: Форма открывается на странице "Промежуточные пробы"
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-03: Загрузка данных на странице "Произвольный композит"**
- [ ] Предусловия: Есть тестовые регистрации
- [ ] Установить отборы (организация, ПЛК, дата)
- [ ] Нажать "Обновить"
- [ ] **Ожидаемый результат**: Таблица заполнилась данными за < 3 секунд
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-04: Интерактивное выделение строк**
- [ ] Предусловия: Таблица заполнена данными
- [ ] Выделить одну строку (поставить флажок)
- [ ] **Ожидаемый результат**: Все строки с той же группой ТС и показателем выделены
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-05: Интерактивное снятие выделения**
- [ ] Предусловия: Несколько строк выделены
- [ ] Снять флажок с одной строки
- [ ] **Ожидаемый результат**: Все связанные строки сняты с выделения
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-06: Навигация по производственным суткам (+1 день)**
- [ ] Предусловия: Форма открыта
- [ ] Нажать кнопку "+1 день"
- [ ] **Ожидаемый результат**: Дата увеличилась на 1 день, данные обновились
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-07: Навигация по производственным суткам (-1 день)**
- [ ] Предусловия: Форма открыта
- [ ] Нажать кнопку "-1 день"
- [ ] **Ожидаемый результат**: Дата уменьшилась на 1 день, данные обновились
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-08: Валидация - отсутствие выделенных строк**
- [ ] Предусловия: Форма открыта, ничего не выделено
- [ ] Нажать "Сформировать пробы"
- [ ] **Ожидаемый результат**: Предупреждение "Не выбрано ни одной строки"
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-09: Валидация - разная номенклатура**
- [ ] Предусловия: Выделены строки с разной номенклатурой
- [ ] Нажать "Сформировать пробы"
- [ ] **Ожидаемый результат**: Предупреждение "Номенклатура отличается"
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-10: Валидация - разный контрагент**
- [ ] Предусловия: Выделены строки с разным контрагентом
- [ ] Нажать "Сформировать пробы"
- [ ] **Ожидаемый результат**: Запрос подтверждения "Контрагент отличается. Продолжить?"
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

#### 6.2.2 Тест-кейсы для формы формирования композитной пробы

**TC-11: Открытие формы формирования**
- [ ] Предусловия: Выделены корректные строки
- [ ] Нажать "Сформировать пробы"
- [ ] **Ожидаемый результат**: Открылась форма формирования с заполненными данными
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-12: Автозагрузка показателей из нормативной аттестации**
- [ ] Предусловия: Номенклатура имеет нормативную аттестацию
- [ ] Открыть форму формирования
- [ ] **Ожидаемый результат**: Таблица показателей заполнена автоматически
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-13: Ручное добавление показателя**
- [ ] Предусловия: Форма формирования открыта
- [ ] Нажать "Добавить показатель", выбрать показатель
- [ ] **Ожидаемый результат**: Показатель добавлен в таблицу
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-14: Удаление показателя**
- [ ] Предусловия: В таблице есть показатель
- [ ] Выбрать показатель, нажать "Удалить"
- [ ] **Ожидаемый результат**: Показатель удален после подтверждения
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-15: Формирование документа**
- [ ] Предусловия: Форма заполнена корректно
- [ ] Нажать "Сформировать документ"
- [ ] **Ожидаемый результат**: Создан документ гкс_ФормированиеНомераПробы
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-16: Создание лабораторного анализа**
- [ ] Предусловия: Документ формирования номера пробы создан
- [ ] Проверить наличие связанного лабораторного анализа
- [ ] **Ожидаемый результат**: Документ гкс_ЛабораторныйАнализ создан и связан
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-17: Запись в регистр гкс_КомпозитныеПробы**
- [ ] Предусловия: Документ проведен
- [ ] Проверить записи в регистре
- [ ] **Ожидаемый результат**: Для каждой регистрации и показателя создана запись
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-18: Обновление состояния качества**
- [ ] Предусловия: Документ проведен
- [ ] Проверить РС.гкс_ПоказателиКачестваУсиленногоКонтроля
- [ ] **Ожидаемый результат**: Состояние качества обновлено на "ОтборПроб"
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-19: Обработка отклоненной регистрации**
- [ ] Предусловия: Есть регистрация со статусом "НеПринято"
- [ ] Включить ее в формирование пробы, провести документ
- [ ] **Ожидаемый результат**: Состояние = "НеПринятоВходнойКонтроль", не включена в пробу
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

**TC-20: Открытие существующего документа**
- [ ] Предусловия: Для регистрации уже есть композитная проба
- [ ] Выделить эту регистрацию, нажать "Сформировать пробы"
- [ ] **Ожидаемый результат**: Открывается существующий документ (не создается новый)
- [ ] **Фактический результат**:
- [ ] **Статус**: [ ] Passed / [ ] Failed

#### Чеклист 6.2:
- [ ] Все 20 тест-кейсов выполнены
- [ ] Минимум 18 из 20 тестов пройдены (90%)
- [ ] Критичные тесты (TC-01, TC-03, TC-15, TC-16) пройдены
- [ ] Все найденные дефекты задокументированы

### 6.3 Тестирование производительности

**Время**: 3 часа

#### 6.3.1 Нагрузочные тесты

**Тест 1: Загрузка 1000 регистраций**
- [ ] Создать 1000 тестовых регистраций
- [ ] Открыть АРМ, загрузить данные
- [ ] **Ожидаемый результат**: Загрузка < 3 секунд
- [ ] **Фактическое время**: ___ секунд
- [ ] **Статус**: [ ] Passed / [ ] Failed

**Тест 2: Массовое выделение 500 строк**
- [ ] Загрузить 500 строк одной группы ТС
- [ ] Выделить одну строку
- [ ] **Ожидаемый результат**: Все 500 строк выделены < 1 секунды
- [ ] **Фактическое время**: ___ секунд
- [ ] **Статус**: [ ] Passed / [ ] Failed

**Тест 3: Формирование пробы из 100 регистраций**
- [ ] Выделить 100 регистраций
- [ ] Сформировать пробу
- [ ] **Ожидаемый результат**: Создание документа < 5 секунд
- [ ] **Фактическое время**: ___ секунд
- [ ] **Статус**: [ ] Passed / [ ] Failed

#### Чеклист 6.3:
- [ ] Все 3 нагрузочных теста выполнены
- [ ] Все тесты пройдены (производительность приемлема)
- [ ] Результаты задокументированы

### 6.4 Регрессионное тестирование

**Время**: 3 часов

#### Задачи:
- [ ] Проверить работу существующих документов гкс_РегистрацияНаПЛК
- [ ] Проверить работу других форм формирования проб
- [ ] Проверить проведение документов гкс_ЛабораторныйАнализ
- [ ] Проверить отчеты по качеству
- [ ] Проверить интеграцию с другими подсистемами

#### Чеклист 6.4:
- [ ] Регрессионное тестирование выполнено
- [ ] Нет новых дефектов в существующем функционале
- [ ] Все критичные сценарии работают

---

## Этап 7: Оптимизация

**Длительность**: 1.5 дня (12 часов)
**Ответственный**: Разработчик 1С, Администратор БД

### 7.1 Оптимизация запросов

**Время**: 4 часа

#### Задачи:
- [ ] Проанализировать планы выполнения всех запросов
- [ ] Оптимизировать запрос ТекстЗапросаДанныеДляДетальныхЗаписей()
- [ ] Добавить индексы по результатам анализа
- [ ] Проверить использование временных таблиц
- [ ] Убрать точечную нотацию везде, где возможно

**Инструменты**:
- Консоль запросов 1С
- Монитор производительности SQL Server
- Замер времени выполнения

#### Чеклист 7.1:
- [ ] Все запросы проанализированы
- [ ] Время выполнения основного запроса < 2 секунд
- [ ] Индексы созданы и используются
- [ ] Документация обновлена

### 7.2 Оптимизация клиентского кода

**Время**: 2 часа

#### Задачи:
- [ ] Минимизировать обращения к серверу
- [ ] Оптимизировать интерактивное выделение строк
- [ ] Добавить кэширование там, где возможно
- [ ] Убрать лишние обновления данных

#### Чеклист 7.2:
- [ ] Клиентский код оптимизирован
- [ ] UI отзывчив (< 0.5 сек на действие)
- [ ] Нет лишних обращений к серверу

### 7.3 Оптимизация памяти

**Время**: 2 часа

#### Задачи:
- [ ] Проверить утечки памяти
- [ ] Оптимизировать размер временных таблиц
- [ ] Убрать неиспользуемые переменные
- [ ] Оптимизировать копирование больших таблиц значений

#### Чеклист 7.3:
- [ ] Утечек памяти нет
- [ ] Потребление памяти приемлемо (< 200 МБ)
- [ ] Документация обновлена

### 7.4 Code Review и рефакторинг

**Время**: 4 часа

#### Задачи:
- [ ] Провести code review всего кода
- [ ] Проверить соответствие стандартам разработки
- [ ] Убрать дублирование кода
- [ ] Улучшить читаемость кода
- [ ] Добавить комментарии где нужно
- [ ] Проверить обработку ошибок

**Чеклист Code Review**:
```
ОБЩЕЕ:
- [ ] Код соответствует стандартам разработки 1С
- [ ] Именование переменных понятное и консистентное
- [ ] Нет магических чисел и строк
- [ ] Комментарии актуальны и полезны

ПРОИЗВОДИТЕЛЬНОСТЬ:
- [ ] Нет N+1 запросов
- [ ] Используются правильные типы данных
- [ ] Нет неоптимальных циклов
- [ ] Кэширование используется где нужно

БЕЗОПАСНОСТЬ:
- [ ] Все запросы параметризованы
- [ ] Нет SQL-инъекций
- [ ] Права доступа проверяются
- [ ] Логирование ошибок без раскрытия данных

НАДЕЖНОСТЬ:
- [ ] Все исключения обрабатываются
- [ ] Транзакции используются правильно
- [ ] Валидация данных везде где нужно
- [ ] Откаты при ошибках работают

ПОДДЕРЖИВАЕМОСТЬ:
- [ ] Код модульный и переиспользуемый
- [ ] Нет дублирования кода
- [ ] Зависимости минимальны
- [ ] Тесты покрывают критичный функционал
```

#### Чеклист 7.4:
- [ ] Code review проведен
- [ ] Все замечания исправлены
- [ ] Код соответствует стандартам
- [ ] Документация обновлена

---

## Этап 8: Документация и внедрение

**Длительность**: 1 день (8 часов)
**Ответственный**: Разработчик 1С, Бизнес-аналитик

### 8.1 Пользовательская документация

**Время**: 3 часа

#### 8.1.1 Руководство пользователя

**Создать документ**: `Руководство пользователя АРМ Промежуточный композит.md`

**Содержание**:
```markdown
# Руководство пользователя: АРМ Промежуточный композит

## 1. Назначение
Описание назначения АРМ...

## 2. Открытие АРМ
Инструкция по открытию...

## 3. Работа с произвольным композитом
### 3.1 Установка отборов
### 3.2 Выделение строк
### 3.3 Формирование композитной пробы

## 4. Работа с промежуточными пробами
### 4.1 Просмотр списка проб
### 4.2 Просмотр состава пробы
### 4.3 Редактирование пробы

## 5. Часто задаваемые вопросы

## 6. Устранение проблем
```

**Скриншоты**:
- [ ] Скриншот главной формы
- [ ] Скриншот выделения строк
- [ ] Скриншот формы формирования пробы
- [ ] Скриншот созданного документа

#### 8.1.2 Краткая справка

**Создать**: Встроенная справка в форме (F1)

#### Чеклист 8.1:
- [ ] Руководство пользователя создано
- [ ] Скриншоты добавлены
- [ ] Краткая справка встроена в форму
- [ ] Документация проверена бизнес-аналитиком

### 8.2 Техническая документация

**Время**: 2 часа

#### Задачи:
- [ ] Обновить все аналитические отчеты (01, 02, 03)
- [ ] Создать документ "Инструкция по развертыванию"
- [ ] Создать документ "Известные ограничения"
- [ ] Обновить схему архитектуры

#### Чеклист 8.2:
- [ ] Техническая документация актуальна
- [ ] Инструкция по развертыванию создана
- [ ] Известные ограничения задокументированы

### 8.3 Подготовка релиза

**Время**: 2 часа

#### 8.3.1 Создание релиза

**Шаги**:
```bash
# 1. Финализация ветки
git checkout feature/251029_intermediate_composite
git pull origin feature/251029_intermediate_composite

# 2. Тестирование финальной версии
# Запустить все тесты

# 3. Слияние с main
git checkout master
git merge feature/251029_intermediate_composite

# 4. Создание тега
git tag -a v1.0.0-arm-intermediate-composite -m "Release АРМ Промежуточный композит v1.0.0"

# 5. Push в репозиторий
git push origin master
git push origin v1.0.0-arm-intermediate-composite
```

#### 8.3.2 Release Notes

**Создать файл**: `RELEASE_NOTES_v1.0.0.md`

**Содержание**:
```markdown
# Release Notes: АРМ Промежуточный композит v1.0.0

## Дата релиза
ГГГГ-ММ-ДД

## Новые возможности
- Обработка гкс_АРМПромежуточныйКомпозит
- Интерактивное выделение строк по группам ТС
- Автоматическое формирование композитных проб
- Интеграция с лабораторным анализом

## Технические улучшения
- 6 новых индексов для производительности
- Оптимизация SQL запросов (ускорение в 4-10 раз)
- Клиент-серверная архитектура
- Логирование производительности

## Исправленные ошибки
- Нет (новая функциональность)

## Известные ограничения
- Максимум 1000 регистраций в одной пробе
- Время загрузки данных зависит от количества записей

## Требования
- 1С:Предприятие 8.3.26+
- SQL Server 2016+ (или PostgreSQL 12+)

## Инструкции по обновлению
1. Создать резервную копию БД
2. Загрузить конфигурацию
3. Обновить конфигурацию БД
4. Проверить работу АРМ

## Контакты
...
```

#### Чеклист 8.3:
- [ ] Релиз создан в Git
- [ ] Тег проставлен
- [ ] Release Notes созданы
- [ ] Конфигурация выгружена в .cf

### 8.4 Обучение пользователей

**Время**: 1 час

#### Задачи:
- [ ] Провести обучение ключевых пользователей
- [ ] Показать демонстрацию работы АРМ
- [ ] Ответить на вопросы
- [ ] Передать руководство пользователя

#### Чеклист 8.4:
- [ ] Обучение проведено
- [ ] Пользователи готовы к работе
- [ ] Документация передана
- [ ] Обратная связь собрана

---

## Заключение

### Итоговый чеклист проекта

**Этапы**:
- [ ] Этап 0: Подготовка (0.5 дня)
- [ ] Этап 1: Создание структуры данных (1 день)
- [ ] Этап 2: Разработка серверной логики (2 дня)
- [ ] Этап 3: Разработка основной формы (2.5 дня)
- [ ] Этап 4: Форма формирования композитной пробы (1.5 дня)
- [ ] Этап 5: Интеграция с документами (2 дня)
- [ ] Этап 6: Тестирование (2 дня)
- [ ] Этап 7: Оптимизация (1.5 дня)
- [ ] Этап 8: Документация и внедрение (1 день)

**ИТОГО**: 14 рабочих дней

### Критерии успеха

✅ **Проект считается успешным, если**:
1. Все функции из ТЗ реализованы
2. 90%+ тестов пройдены
3. Производительность: запросы < 3 сек, UI < 0.5 сек
4. Code review пройден
5. Документация создана
6. Обучение пользователей проведено
7. Релиз создан и задеплоен

### Метрики качества

- **Покрытие тестами**: > 70%
- **Количество дефектов**: < 5 критичных
- **Производительность**: Соответствует SLA
- **Удовлетворенность пользователей**: > 4/5

---

**Конец плана реализации**

**Дата составления**: 2025-10-29
**Версия**: 1.0
**Статус**: ✅ Готов к выполнению

*Этот план является живым документом и может быть обновлен в процессе реализации.*
