// Модуль формы записи регистра настроек отключения входного контроля
// Реализует условную видимость полей в зависимости от вида перевозки по аналогии с усиленным контролем

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЗаполнитьЗначениеЗаписи(Запись, Параметры, "ВидПеревозки");
	ЗаполнитьЗначениеЗаписи(Запись, Параметры, "ТочкаМаршрута");

	УстановитьВидимостьДоступность(); 
		
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)

	// Проверка корректности периода
	Если ПроверкаКорректностиПериода() Тогда
			ТекстСообщения = НСтр("ru = 'Дата окончания не может быть меньше даты начала'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения, , , , Истина);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ВидПеревозкиПриИзменении(Элемент)
	УстановитьВидимостьДоступность();
	Запись.ТранспортноеСредство = ПредопределенноеЗначение("Справочник.ТранспортныеСредства.ПустаяСсылка");
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьЗначениеЗаписи(ЗаписьРегистра, ПараметрыЗаписи, ИмяРеквизита)
	Если Не ЗначениеЗаполнено(ЗаписьРегистра[ИмяРеквизита])
		И ПараметрыЗаписи.Свойство(ИмяРеквизита) Тогда 
		ЗаписьРегистра[ИмяРеквизита] = ПараметрыЗаписи[ИмяРеквизита];
	КонецЕсли;	                                     
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьДоступность()
	// Определение типа перевозки
	ЭтоЖД = Ложь;
	Если ЗначениеЗаполнено(Запись.ВидПеревозки) Тогда
		ЭтоЖД = Перечисления.гкс_ТипыТранспортныхСредствДоставки.ЭтоЖДПеревозка(Запись.ВидПеревозки);
	КонецЕсли;
	
	// Условная видимость полей в зависимости от вида перевозки
	Элементы.ГруппаЖДСтанция.Видимость = ЭтоЖД;
	Элементы.ПунктПогрузки.Видимость = НЕ ЭтоЖД;
	
	// Установка подсказок для полей
	Если ЭтоЖД Тогда
		Элементы.ЖДСтанция.Подсказка = "Оставьте пустым для применения ко всем ЖД станциям";
		Запись.ПунктПогрузки = Справочники.гкс_ТочкиМаршрута.ПустаяСсылка();
	Иначе
		Элементы.ПунктПогрузки.Подсказка = "Оставьте пустым для применения ко всем пунктам погрузки";
		Запись.ЖДСтанция = Справочники.гкс_КлассификаторСтанцийЖД.ПустаяСсылка();
	КонецЕсли;
	
	Если РеквизитНеДоступен() Тогда
		Элементы.ВидПеревозки.ТолькоПросмотр = Истина;
		Элементы.ТочкаМаршрута.ТолькоПросмотр = Истина;
	КонецЕсли;

КонецПроцедуры

// Реквизит не доступен.
// 
// Возвращаемое значение:
//  Булево - Реквизит не доступен
&НаСервере
Функция РеквизитНеДоступен()
	
	Возврат Не Пользователи.ЭтоПолноправныйПользователь()
		Или Параметры.Свойство("ОткрытаИзОбработки") 
		И Параметры["ОткрытаИзОбработки"];
КонецФункции

// Проверка корректности периода.
// 
// Возвращаемое значение:
//  Булево - Проверка корректности периода
&НаСервере
Функция ПроверкаКорректностиПериода()
	ПустаяДата = Дата(1,1,1);
	
	Возврат ЗначениеЗаполнено(Запись.ДатаНачала) 
		И ЗначениеЗаполнено(Запись.ДатаОкончания) 
		И Запись.ДатаОкончания <> ПустаяДата 
		И Запись.ДатаОкончания < Запись.ДатаНачала; 
КонецФункции

#КонецОбласти