# Итоговое сравнение качества поиска: all-minilm vs nomic-embed-text

**Дата**: 2025-11-03
**Версия**: 1.0
**Статус**: ЗАВЕРШЕНО

---

## Executive Summary

**КРИТИЧЕСКИЙ РЕЗУЛЬТАТ:** Модель all-minilm:l6-v2, несмотря на **19.1x ускорение**, показала **неприемлемо низкое качество** поиска по BSL-коду.

- **Средний overlap**: 12.0% (критично низко)
- **Падение relevance**: -20% до -40%
- **Вердикт**: **STAY on nomic-embed-text:latest**
- **Решение**: НЕ ПЕРЕХОДИТЬ на all-minilm:l6-v2 для продакшн-индексации

---

## Методология тестирования

### Тестовые данные
- **Коллекция 1**: `bsl_code` (nomic-embed-text:latest, 768-dim, 100 файлов)
- **Коллекция 2**: `bsl_allminilm_test` (all-minilm:l6-v2, 384-dim, 100 файлов)
- **Одинаковые файлы**: Первые 100 BSL-файлов из `src/`

### Тестовые запросы
5 типичных запросов для работы с BSL-кодом 1С:
1. "работа с документами" (work with documents)
2. "проведение документа" (document posting)
3. "запись в регистр" (register write)
4. "расчет остатков" (balance calculation)
5. "формирование отчета" (report generation)

### Метрики
- **Top-5 Overlap**: Процент совпадений в топ-5 результатов между моделями
- **Relevance Score**: Cosine similarity (0-1)
- **Критерии успеха**:
  - ≥70% overlap → EXCELLENT → SWITCH
  - ≥50% overlap → ACCEPTABLE → SWITCH_WITH_CAUTION
  - <50% overlap → POOR → STAY

---

## Результаты

### Сводная таблица

| Запрос | Overlap | nomic avg | minilm avg | Разница |
|--------|---------|-----------|------------|---------|
| работа с документами | 0/5 (0%) | 0.694 | 0.425 | **-38.7%** |
| проведение документа | 0/5 (0%) | 0.709 | 0.476 | **-32.9%** |
| запись в регистр | 2/5 (40%) | 0.688 | 0.489 | **-28.9%** |
| расчет остатков | 1/5 (20%) | 0.678 | 0.486 | **-28.3%** |
| формирование отчета | 0/5 (0%) | 0.714 | 0.583 | **-18.4%** |
| **СРЕДНЕЕ** | **3/25 (12%)** | **0.697** | **0.492** | **-29.4%** |

### Детализация по запросу #1: "работа с документами"

**nomic-embed-text (score 0.73-0.68):**
```
1. Reports/ДатыЗапретаИзменения/ObjectModule.bsl ✅ (релевантно)
2. Reports/КонтрольРассылкиОтчетов/ManagerModule.bsl ✅ (релевантно)
3. InformationRegisters/СостоянияУспешныхОбменовДанными/RecordSetModule.bsl ✅
4. SettingsStorages/ХранилищеВариантовОтчетов/Forms/ГруппаВыбранныхПолей/Module.bsl ✅
5. InformationRegisters/СостоянияУспешныхОбменовДанными/ManagerModule.bsl ✅
```

**all-minilm:l6-v2 (score 0.44-0.41):**
```
1. Reports/ДлительностьОтложенногоОбновления/ManagerModule.bsl ❌ (не релевантно)
2. Reports/гкс_СвязанныеСообщения/Forms/ФормаОтчета/Module.bsl ⚠️ (слабо релевантно)
3. InformationRegisters/УдалитьРезультатыОбменаДанными/ManagerModule.bsl ⚠️
4. InformationRegisters/ФиксацияОбработкиДанныхОбработчиками/ManagerModule.bsl ❌
5. InformationRegisters/УдалитьНастройкиТранспортаОбмена/ManagerModule.bsl ❌
```

**Overlap: 0/5** ❌

### Детализация по запросу #3: "запись в регистр" (лучший результат)

**Общие модули (2/5 совпадений):**
- `InformationRegisters/УдалитьСервераОчередей/ManagerModule.bsl`
- `InformationRegisters/СпискиОтзываСертификатов/RecordSetModule.bsl`

**Overlap: 40%** - это ЛУЧШИЙ результат из всех запросов, но все равно ниже порога 50%!

---

## Анализ проблем all-minilm:l6-v2

### 1. Низкие Relevance Scores
- **nomic**: в среднем 0.70 (70% similarity)
- **all-minilm**: в среднем 0.49 (49% similarity)
- **Потеря**: -29.4% качества

### 2. Плохое понимание русскоязычного контекста
Модель all-minilm:l6-v2 обучена в основном на английском корпусе текстов и плохо справляется с:
- Русскими терминами 1С ("проведение", "регистр", "остатки")
- Структурой BSL-кода на кириллице
- Семантикой доменной области 1С

### 3. Меньшая размерность embeddings
- **nomic**: 768 измерений
- **all-minilm**: 384 измерения (в 2 раза меньше)
- **Следствие**: Потеря детализации семантического представления

### 4. Неконсистентные результаты
- Запросы с разными темами дают разную степень деградации (от -18% до -39%)
- Непредсказуемо, какие запросы будут работать хорошо

---

## Альтернативные пути оптимизации

### Отклоненные подходы
1. ❌ **GPU-ускорение через Ollama**
   - Причина: AMD GPU вместо NVIDIA
   - Ollama поддерживает только NVIDIA CUDA, не AMD ROCm

2. ❌ **Переход на all-minilm:l6-v2**
   - Причина: 12% overlap - неприемлемо низко
   - Потеря качества (-29%) не оправдывает 19x ускорение

### Рекомендуемые подходы

#### A. Оптимизация AsyncIO-индексатора (текущий)
**Текущие параметры:**
```python
batch_size = 5
max_workers = 2
timeout = 60
```

**Потенциал оптимизации:**
- Увеличить `batch_size` → 10-20 (1.5-2x ускорение)
- Увеличить `max_workers` → 4-6 (1.3-1.5x ускорение)
- Увеличить `timeout` → 90-120 (снизить ошибки)

**Ожидаемый эффект:** 2-3x ускорение (21h → 7-10h)

#### B. Hybrid подход: AsyncIO (parsing) + multiprocessing (embeddings)
```python
parse_workers = 12   # CPU-intensive
embedding_workers = 3  # I/O-intensive
batch_size = 10
```

**Преимущества:**
- Параллелизм парсинга BSL-файлов (12 ядер CPU)
- Параллелизм создания embeddings (3 workers)
- Оптимальное использование ресурсов

**Ожидаемый эффект:** 3-4x ускорение (21h → 5-7h)

#### C. Кастомная fine-tuned модель (долгосрочно)
- Дообучить nomic-embed-text на BSL-корпусе
- Сохранить качество, добавить специализацию
- Долго, сложно, но возможно даст лучшие результаты

#### D. Переход на коммерческую API (OpenAI, Anthropic)
- **OpenAI text-embedding-3-large**: 3072-dim, высокое качество
- **Cohere embed-multilingual-v3**: Специально для многоязычности
- **Минус**: Стоимость ($0.13 per 1M tokens)

---

## Итоговое решение и дальнейшие действия

### Решение
**STAY on nomic-embed-text:latest** для продакшн-индексации

### Обоснование
1. all-minilm:l6-v2 показывает критически низкое качество (12% overlap)
2. Потеря -29% relevance scores неприемлема для семантического поиска
3. Ускорение в 19x не оправдывает деградацию качества
4. Качественный поиск важнее быстрой индексации

### Дальнейшие шаги

**Приоритет 1: Оптимизация параметров AsyncIO-индексатора**
- [ ] Тест batch_size: 5 → 10 → 15 → 20
- [ ] Тест max_workers: 2 → 4 → 6
- [ ] Подбор оптимального сочетания параметров
- [ ] Ожидаемый результат: 2-3x ускорение

**Приоритет 2: Завершение production Qdrant indexing**
- [x] AsyncIO indexer завершен: 3908/3973 (98.4%)
- [ ] Upload 3908 embeddings в Qdrant collection
- [ ] Верификация полноты данных

**Приоритет 3 (опционально): Исследование Hybrid подхода**
- [ ] Реализовать гибридный индексатор
- [ ] Бенчмарк на 200-500 файлах
- [ ] Сравнение с оптимизированным AsyncIO

**Приоритет 4 (долгосрочно): Fine-tuning модели**
- [ ] Подготовка BSL-датасета для fine-tuning
- [ ] Исследование подходов к fine-tuning nomic-embed-text
- [ ] Оценка ресурсов и времени

---

## Артефакты и логи

### Файлы результатов
```
ai-memory-system/logs/search_quality_comparison.txt - детальные результаты
ai-memory-system/logs/allminilm_quality_test.log - лог индексации 100 файлов
ai-memory-system/data/benchmarks/benchmark_results.json - benchmark моделей
```

### Коллекции Qdrant
```
bsl_code:              100 points, nomic-embed-text:latest (768-dim)
bsl_allminilm_test:    100 points, all-minilm:l6-v2 (384-dim)
```

### Benchmark данные
```
Model                    Dimension  Avg Time    Speedup    Status
nomic-embed-text:latest  768        53,313 ms   1.00x      ✅ baseline
all-minilm:l6-v2         384        2,786 ms    19.14x     ❌ low quality
mxbai-embed-large        1024       82,450 ms   0.65x      ⚠️ slower
nomic-embed-text:v1.5    768        51,200 ms   1.04x      ✅ comparable
```

---

## Выводы

1. **all-minilm:l6-v2 НЕ ПОДХОДИТ** для индексации BSL-кода из-за плохого качества
2. **nomic-embed-text:latest остается лучшим выбором** для семантического поиска
3. **Оптимизация параметров** - наиболее реалистичный путь к 2-3x ускорению
4. **GPU-ускорение невозможно** на текущем железе (AMD вместо NVIDIA)
5. **Качество поиска важнее скорости индексации** - это ключевой принцип

---

**Автор**: Claude Code AI
**Дата**: 2025-11-03
**Проект**: 1C-Enterprise_Framework / ai-memory-system
