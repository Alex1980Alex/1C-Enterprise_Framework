# Выполненные работы по задаче GKSTCPLK-1706

## Описание задачи
Реализация механизма блокировки транспортных средств от одного поставщика до получения результатов лабораторного анализа первого ТС.

## Техническое задание

### 1. Блокировка ТС по правилу первого транспорта
Если ТС заехало по правилу первого ТС, то остальные ТС от этого поставщика не должны иметь возможности разгружаться пока не будет принят анализ от первого ТС.

### 2. Обработка лабораторного анализа

#### Статус "ОтборПроб" или пустой:
- Анализируются присутствующие показатели
- Создаются записи состояний:
  - Приемка - ОтборПроб
  - ПриемкаУсиленныйКонтроль - ОтборПроб (с учетом ситуации "ПробыНеТребуются")

#### Статус "Выполнен":
- Обработка показателей входного/усиленного контроля
- Запись итогового качества по типам:
  - Приемка
  - ПриемкаУсиленныйКонтроль (если применимо)
- Для первой машины - обновление состояний заблокированных ТС

## Реализованные изменения

### 1. Доработка структуры данных

#### Перечисление гкс_СостоянияРегистрации
Добавлено новое значение:
```
ЗаблокированоПоПервомуТС - состояние блокировки ТС до получения результатов анализа первого транспорта
```

#### Регистр сведений гкс_СостоянияРегистрации
Добавлен реквизит:
```
ПервоеТСПоставщика - СправочникСсылка.гкс_РегистрацияНаПЛК - ссылка на документ первого ТС
```

### 2. Модуль гкс_ПриемкаНаПЛКСервер

#### Новые функции:

**БлокироватьРегистрацииПоставщикаПоПервомуТС()**
- Параметры: ДокументРегистрации, Поставщик, ДатаРегистрации
- Находит все регистрации поставщика за день
- Устанавливает состояние "ЗаблокированоПоПервомуТС"
- Сохраняет ссылку на первое ТС

**ПроверитьИОбновитьСостоянияЗаблокированныхТС()**
- Параметры: ПервоеТС, РезультатАнализа
- Обновляет состояния заблокированных ТС на основе результатов анализа
- Разблокирует ТС при положительном результате

**ОбработатьПоказателиЛабораторногоАнализа()**
- Унифицированная обработка показателей входного и усиленного контроля
- Использует существующий механизм вычисления качества
- Поддерживает массовую обработку показателей

### 3. Интеграция с документом гкс_ЛабораторныйАнализ

#### Доработка процедуры ЗаписатьДанные()
```bsl
// Проверка первого ТС с заблокированными регистрациями
Если ЕстьЗаблокированныеТСПоПервому(ДокументРегистрации) Тогда
    // Обработка результатов для первого ТС
    ОбработатьРезультатыПервогоТС(ДокументРегистрации, РезультатАнализа);
    
    // Обновление состояний заблокированных ТС
    ОбновитьСостоянияЗаблокированныхТС(ДокументРегистрации, РезультатАнализа);
КонецЕсли;
```

### 4. Алгоритм работы

#### При регистрации ТС:
1. Проверка: является ли это первым ТС от поставщика за день
2. Если да - блокировка всех последующих ТС этого поставщика
3. Запись состояния "ЗаблокированоПоПервомуТС" с указанием первого ТС

#### При проведении лабораторного анализа:
1. Определение статуса анализа (ОтборПроб/Выполнен)
2. Обработка показателей согласно типу контроля
3. Вычисление итогового качества
4. Если это анализ первого ТС - обновление всех заблокированных

#### При попытке разгрузки:
1. Проверка состояния регистрации
2. Если "ЗаблокированоПоПервомуТС" - отказ в разгрузке
3. Вывод сообщения о необходимости ожидания результатов анализа

## Тестирование

### Сценарии тестирования:

1. **Регистрация первого ТС**
   - Создание регистрации для нового поставщика
   - Проверка автоматической блокировки последующих ТС

2. **Лабораторный анализ со статусом "ОтборПроб"**
   - Создание записей для входного контроля
   - Создание записей для усиленного контроля
   - Учет ситуации "ПробыНеТребуются"

3. **Лабораторный анализ со статусом "Выполнен"**
   - Положительный результат - разблокировка ТС
   - Отрицательный результат - сохранение блокировки
   - Обновление состояний всех связанных ТС

4. **Попытка разгрузки заблокированного ТС**
   - Проверка запрета на разгрузку
   - Корректное отображение причины блокировки

## Преимущества реализации

1. **Безопасность**: Исключена возможность разгрузки непроверенной продукции
2. **Автоматизация**: Процесс блокировки/разблокировки полностью автоматический
3. **Гибкость**: Учтены различные сценарии контроля качества
4. **Масштабируемость**: Механизм легко расширяется для новых типов контроля
5. **Прозрачность**: Четкая индикация причин блокировки для пользователей

## Рекомендации по дальнейшему развитию

1. Добавить настройку времени действия блокировки
2. Реализовать уведомления о разблокировке ТС
3. Добавить отчетность по заблокированным ТС
4. Предусмотреть ручную разблокировку с обоснованием